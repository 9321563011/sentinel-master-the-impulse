<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel - Master the Impulse MVP</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for a nice font and colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo
                        'secondary': '#f97316', // Orange
                        'success': '#10b981', // Emerald
                        'danger': '#ef4444', // Red
                        'bg-dark': '#0f172a', // Slate-900 (Main BG)
                        'bg-card': '#1e293b', // Slate-800 (Card BG)
                        'text-light': '#f1f5f9', // Slate-100 (Primary Text)
                        'accent-dark': '#334155', // Slate-700 for input backgrounds
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles for dark mode and main layout */
        body {
            background-color: #0f172a; /* bg-dark */
            color: #f1f5f9; /* text-light */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0; 
        }

        /* Main app container on large screens */
        #app-container {
            max-width: 100%; /* Full width on mobile */
            width: 100%;
            padding: 1rem; /* Added general padding for mobile view content */
        }
        @media (min-width: 640px) {
            #app-container {
                max-width: 600px; /* Keep max-width for desktop centering */
                padding: 2rem; /* Desktop padding */
            }
        }
        
        /* Typography adjustments for better readability */
        h1, h2, h3 {
            letter-spacing: -0.025em; /* Tighten headers slightly */
            font-weight: 800; /* Ensured heroic boldness */
        }
        h1 { font-size: 2.25rem; }
        h2 { font-size: 1.5rem; }
        .text-body { font-size: 1rem; line-height: 1.6; } /* Improved body copy readability */


        /* HEADER FIX: Ensure the header text fits in one line gracefully */
        #main-header-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            width: 100%;
        }
        /* Mobile-specific header sizing for better fit */
        @media (max-width: 639px) {
             #main-header-text {
                font-size: 2rem; /* Slightly smaller font for SENTINEL */
            }
            #main-header-text span {
                font-size: 1.5rem; /* Smaller font for Master the Impulse */
            }
        }

        /* Global Card Styling with subtle animations */
        .app-card {
            background-color: #1e293b; /* bg-card */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.2s ease-in-out;
        }
        .app-card:hover:not(.no-hover) {
            box-shadow: 0 8px 10px -1px rgba(0, 0, 0, 0.3); /* Slight lift on hover */
        }

        /* Custom form input styles */
        input[type="text"], input[type="number"], input[type="tel"], textarea, select {
            background-color: #334155 !important; /* accent-dark */
            border-color: transparent !important; 
            color: #f1f5f9 !important;
            padding: 0.75rem !important; /* Increased padding for mobile touch targets */
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus:not(:disabled), input[type="number"]:focus:not(:disabled), input[type="tel"]:focus:not(:disabled), textarea:focus:not(:disabled), select[type="tel"]:focus:not(:disabled) {
            border-color: transparent !important;
            box-shadow: 0 0 0 2px #4f46e5;
        }
        input[type="date"] {
            color-scheme: dark;
        }
        
        /* Disabled Input Visual Fix */
        input:disabled, textarea:disabled, select:disabled {
            background-color: #1e293b !important; /* bg-card for disabled state */
            border-color: #334155 !important;
            color: #94a3b8 !important; /* slate-400 */
        }


        /* Progress Bar */
        .progress-bar-container {
            height: 1.5rem;
            background-color: #334155;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Buttons - Improved hover/active states */
        .btn {
             transition: all 0.2s ease-in-out, box-shadow 0.2s;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             font-weight: 600;
             padding: 0.8rem 1.2rem; /* Increased padding for better mobile touch target */
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.5);
        }

        /* Radio/Rating Inputs */
        .rating-input + label {
            padding: 0.75rem 0.5rem; 
            font-size: 0.7rem; 
            line-height: 1.1;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            word-break: break-word;
            border-radius: 0.5rem;
            border: none; 
            box-shadow: inset 0 0 0 1px #475569; 
        }
        @media (min-width: 640px) {
            .rating-input + label {
                padding: 0.75rem 1rem;
                font-size: 0.875rem; 
            }
        }
        .rating-input:checked + label { 
            background-color: #f97316; 
            color: white; 
            border: none; 
            transform: scale(1.02); 
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4); 
        }
        .radio-group-error { 
            box-shadow: 0 0 0 3px #ef4444; 
            padding: 8px; 
            border-radius: 0.5rem; 
        }

        /* Log History Entries */
        .log-entry { 
            border-left: 4px solid; 
            padding: 12px; 
            margin-bottom: 8px; 
            border-radius: 0.5rem; 
            transition: all 0.2s; 
        }
        .log-entry:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); 
        }
        .proof-icon { font-size: 2rem; line-height: 1; padding: 4px; border-radius: 6px; background-color: rgba(255, 255, 255, 0.1); }

        /* Modal & Battle Arena */
        .modal-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            z-index: 2000; 
            padding: 1rem;
            overflow-y: auto; 
        }
        
        /* New: Proof Modal Content Constraint */
        .proof-modal-content {
            max-height: 95vh; 
            overflow-y: auto; 
            margin-top: 1rem; 
            margin-bottom: 1rem;
        }
        
        /* CRITICAL FIX: Constrain media elements within the proof preview */
        #proof-preview img, #proof-preview video, #proof-preview audio {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 0.5rem;
            object-fit: contain; 
        }
        

        #arena-log { height: 100px; max-height: 100px; }
        /* REMOVED BORDER STYLES FROM BATTLE CARDS */
        .battle-card:hover { transform: translateY(-2px); box-shadow: 8px 12px rgba(79, 70, 229, 0.3); }
        .battle-active { 
            border: none !important; /* Ensure no border */
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.5); 
        }
        
        /* Mobile adjustments for navigation (CRITICAL FIX) */
        #dashboard-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px; /* Increased gap */
            padding: 10px;
        }
        #dashboard-nav button {
            font-size: 0.7rem; /* Slightly larger font */
            padding: 12px 4px; /* Increased padding for better tap targets */
            line-height: 1; 
            height: auto; 
        }
        @media (min-width: 640px) {
            #dashboard-nav button {
                font-size: 0.875rem;
                padding: 10px 8px;
            }
        }
        
        /* Responsive Avatar/Stats Panel - Mobile stacking behavior */
        #dashboard-display .flex {
            flex-direction: column;
        }
        #avatar-container {
            width: 100%;
        }
        #stats-panel {
            width: 100%;
            padding-top: 1rem;
            border-top: none; 
            margin-top: 1rem;
        }
        @media (min-width: 640px) {
            #dashboard-display .flex {
                flex-direction: row;
            }
            #avatar-container {
                width: 33.3333%;
            }
            #stats-panel {
                width: 66.6666%;
                padding-top: 0;
                border-top: none;
                margin-top: 0;
            }
        }
        
        /* FIX: Splash screen full screen overlay */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f172a; 
            z-index: 3000; 
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }
        #splash-screen.hidden-init {
             display: none; 
        }
        #splash-screen.fade-out {
            opacity: 0;
        }
        
        /* Log Form Toggle - Added transition for smooth open/close */
        #log-form-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        #log-form-container.active {
            max-height: 1000px; 
            transition: max-height 0.5s ease-in;
        }
        
        /* New Heroic/Game Text Styling */
        .hero-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #f97316; /* secondary */
        }

    </style>
</head>
<body class="hidden-init"> <!-- HIDE body until splash is done -->

    <!-- General Purpose Custom Modal (BORDER REMOVED) -->
    <div id="general-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center proof-modal-content">
            <h3 id="general-modal-title" class="text-2xl font-bold text-primary mb-3"></h3>
            <p id="general-modal-message" class="text-text-light mb-5 text-body"></p>
            <button onclick="closeGeneralModal()" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                Acknowledge
            </button>
        </div>
    </div>
    
    <!-- NEW: Full Stats Modal (Hidden by Default) (BORDER REMOVED) -->
    <div id="stats-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-sm proof-modal-content">
            <h3 class="text-2xl font-bold text-primary mb-3">Sentinel Details</h3>
            <div id="full-stats-content" class="space-y-3 p-3 bg-slate-800 rounded-lg">
                <!-- Content injected by openStatsModal() -->
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <p class="font-semibold text-primary">Level:</p><p class="text-text-light" id="stat-level"></p>
                    <p class="font-semibold text-primary">HP:</p><p class="text-text-light" id="stat-hp"></p>
                    <p class="font-semibold text-primary">Willpower:</p><p class="text-text-light" id="stat-willpower"></p>
                    <p class="font-semibold text-primary">Focus:</p><p class="text-text-light" id="stat-focus"></p>
                    <p class="font-semibold text-primary">Defense:</p><p class="text-text-light" id="stat-defense"></p>
                    <p class="font-semibold text-primary">Motivation:</p><p class="text-text-light" id="stat-motivation"></p>
                </div>
            </div>
            <button onclick="document.getElementById('stats-modal').classList.add('hidden')" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200 mt-5">
                Close
            </button>
        </div>
    </div>


    <!-- Proof Submission Modal (Hidden by Default) (BORDER REMOVED) -->
    <div id="proof-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-sm proof-modal-content">
            <h3 class="text-xl font-bold text-secondary mb-2">Quest Proof Submission</h3>
            
            <form id="proof-form" class="space-y-4">
                <input type="hidden" id="proof-task-id">
                <input type="hidden" id="proof-battle-id">
                
                <!-- Task Info -->
                <div class="p-3 bg-slate-800 rounded-lg">
                    <p class="text-lg font-medium text-text-light" id="proof-task-name"></p>
                    <p class="text-sm text-success" id="proof-power-reward"></p>
                </div>
                
                <!-- Proof Type Selector (NEW) -->
                <label for="proof-type-select" class="block text-sm font-medium text-text-light">Select Proof Type:</label>
                <select id="proof-type-select" required onchange="handleProofTypeChange(this.value)" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                    <option value="">Choose Proof Type...</option>
                    <option value="file">üì∏ Media (Image, Video, Audio)</option>
                    <option value="text">üìù Written Proof (Journal Entry)</option>
                </select>

                <!-- Proof Upload and Preview (File Type) -->
                <div id="file-proof-container" class="space-y-4 hidden">
                    <!-- CRITICAL FIX: The preview needs a constrained container for uploaded media -->
                    <div id="proof-preview" class="p-2 bg-slate-800 rounded-lg max-h-40 overflow-hidden text-center text-sm text-slate-400">
                        Upload your file...
                    </div>
                    
                    <label for="proof-file" class="block text-sm font-medium text-text-light">Upload File (Image, Video, Audio)</label>
                    <input type="file" id="proof-file" accept="image/*,video/*,audio/*" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/20 file:text-primary hover:file:bg-primary/30">
                </div>

                <!-- Text Proof Area -->
                <div id="text-proof-container" class="space-y-4 hidden">
                    <label for="proof-text" class="block text-sm font-medium text-text-light">Write Text Proof</label>
                    <textarea id="proof-text" rows="2" placeholder="Write a short summary of task completion..." class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body"></textarea>
                </div>

                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" onclick="closeProofModal()" class="btn bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-xl transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="btn bg-success hover:bg-success/90 text-white font-semibold py-3 px-4 rounded-xl transition duration-200">
                        Confirm & Gain Power
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New: Turn-Based Battle Modal (Impulse Battle Arena) (BORDER REMOVED) -->
    <div id="battle-arena-modal" class="modal-backdrop hidden">
        <div class="bg-slate-700 p-6 rounded-xl shadow-2xl w-full max-w-lg text-center space-y-4 proof-modal-content">
            <h3 class="text-2xl font-bold text-primary mb-2">Impulse Battle Arena</h3>
            
            <!-- Battle Log / Status -->
            <div id="arena-log" class="text-sm bg-slate-800 p-3 rounded-lg text-left h-20 overflow-y-auto">
                <p class="text-slate-400">Battle Starting...</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4 items-center">
                
                <!-- Monster Side -->
                <div class="space-y-1">
                    <div id="arena-monster-emoji" class="text-5xl"></div>
                    <p id="arena-monster-name" class="font-bold text-lg text-danger"></p>
                    <div class="progress-bar-container h-4">
                        <div id="arena-monster-hp-bar" class="progress-bar bg-danger transition-all" style="width: 100%;"></div>
                    </div>
                    <p id="arena-monster-hp-text" class="text-xs text-danger"></p>
                </div>

                <!-- Player Side -->
                <div class="space-y-1">
                    <div id="arena-player-emoji" class="text-5xl">ü•∑</div>
                    <p id="arena-player-name" class="font-bold text-lg text-primary"></p>
                    <div class="progress-bar-container h-4">
                        <div id="arena-player-hp-bar" class="progress-bar bg-primary transition-all" style="width: 100%;"></div>
                    </div>
                    <p id="arena-player-hp-text" class="text-xs text-primary"></p>
                </div>

            </div>

            <!-- Controls (Updated Names) -->
            <div id="arena-controls" class="space-y-3">
                <p id="arena-message" class="text-sm text-yellow-400 font-semibold"></p>
                <div class="grid grid-cols-2 gap-3">
                    <button id="arena-attack-btn" onclick="playerTurn('Attack')" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 rounded-xl">
                        ‚öîÔ∏è Strike
                    </button>
                    <button id="arena-defend-btn" onclick="playerTurn('Defend')" class="btn bg-primary hover:bg-primary/90 text-white font-semibold py-3 rounded-xl">
                        üõ°Ô∏è Guard
                    </button>
                    <button id="arena-skill-1" onclick="playerTurn('Skill1')" class="btn skill-card text-white font-semibold py-3 rounded-xl text-sm opacity-50" disabled>
                        (Skill Slot 1)
                    </button>
                    <button id="arena-skill-2" onclick="playerTurn('Skill2')" class="btn skill-card text-white font-semibold py-3 rounded-xl text-sm opacity-50" disabled>
                        (Skill Slot 2)
                    </button>
                </div>
                <button id="arena-run-btn" onclick="endBattle(false)" class="btn bg-slate-600 hover:bg-slate-500 text-white py-3 px-4 rounded-xl text-sm w-full">
                    üèÉ Runaway (Loss)
                </button>
            </div>
        </div>
    </div>


    <!-- Splash Screen (Now fixed position, hidden initially by CSS) -->
    <div id="splash-screen" class="hidden-init">
        <div class="text-center">
            <h1 class="text-6xl font-extrabold text-primary splash-text" style="animation-delay: 0.2s;">SENTINEL</h1>
            <!-- REMOVED MVP TEXT -->
            <p class="text-2xl text-secondary mt-2 splash-text" style="animation-delay: 0.7s;">Master the Impulse</p>
            <p class="text-sm text-slate-400 mt-6 splash-text" style="animation-delay: 1.2s;">Loading your battlefield...</p>
        </div>
    </div>


    <!-- Main Application Container (FULL WIDTH ON MOBILE, BORDER REMOVED) -->
    <div id="app-container" class="w-full mx-auto bg-slate-800 rounded-none sm:rounded-xl space-y-6">

        <!-- HEADER: RENAMED AND STYLED TO FIT ONE LINE -->
        <header class="text-center pb-4">
            <!-- Updated header structure for visibility -->
            <h1 id="main-header-text" class="text-3xl sm:text-4xl font-extrabold text-primary">SENTINEL <span class="text-secondary text-2xl sm:text-3xl font-semibold">Master the Impulse</span></h1>
        </header>

        <!-- 0. Character Creation Section (MINIMAL) -->
        <div id="character-creation-section" class="space-y-6 app-card hidden p-4 sm:p-6">
            <form id="character-form" class="space-y-4">
                <div id="step-1" class="space-y-4">
                    
                    <label for="char-real-name" class="block text-sm font-medium text-text-light">Your Name</label>
                    <input type="text" id="char-real-name" placeholder="Enter your name" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                    
                    <label for="char-phone" class="block text-sm font-medium text-text-light">Phone Number</label>
                    <input type="tel" id="char-phone" placeholder="9876543210" required pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="char-age" class="block text-sm font-medium text-text-light">Age</label>
                            <input type="number" id="char-age" placeholder="Age" min="15" max="100" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                        </div>
                        
                        <!-- NEW FIELD: GENDER -->
                         <div>
                            <label for="char-gender" class="block text-sm font-medium text-text-light">Gender</label>
                            <select id="char-gender" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label for="char-city" class="block text-sm font-medium text-text-light">City</label>
                            <input type="text" id="char-city" placeholder="Your City" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                        </div>
                        
                        <!-- Source is now responsive -->
                        <div>
                            <label for="char-source" class="block text-sm font-medium text-text-light">How did you find us</label>
                            <select id="char-source" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                                <option value="">Select source...</option>
                                <option value="Friend/Referral">Friend/Referral</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Search Engine">Search Engine (Google, Bing, etc.)</option>
                                <option value="Ad/Marketing">Ad/Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SUBMIT BUTTON ONLY -->
                <div class="flex justify-center pt-4 border-t border-slate-600">
                    <button type="submit" id="submit-btn" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 px-8 rounded-xl transition duration-200">
                        Start Game!
                    </button>
                </div>
            </form>
        </div>


        <!-- 1. Trigger Input Section -->
        <div id="trigger-section" class="hidden space-y-6">
            
            <!-- Dashboard Stats and Avatar (HEADER REMOVED, BORDER/SHADOW TWEAKED) -->
            <div id="dashboard-display" 
                 class="p-4 app-card cursor-pointer hover:bg-slate-700/80 transition duration-200"
                 onclick="openStatsModal()">
                
                <!-- Minimal Display Content -->
                <div class="flex items-center space-x-4">
                    <!-- Avatar (Left) -->
                    <div id="avatar-container" class="flex-shrink-0 flex flex-col items-center justify-center p-3 rounded-lg">
                        <!-- Avatar content injected here -->
                    </div>
                    <!-- Stats Panel (Right - Minimal) -->
                    <div id="stats-panel" class="flex-grow space-y-2 p-2">
                        <!-- Minimal Stats content injected here -->
                    </div>
                </div>
                
            </div>

            <!-- Dashboard Navigation Buttons (BORDER REMOVED) -->
            <div id="dashboard-nav" class="app-card">
                <button 
                    id="nav-log" 
                    class="btn bg-primary text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('log')">
                    üìù Logs
                </button>
                <button 
                    id="nav-battle" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('battle')">
                    ‚öîÔ∏è Battles
                </button>
                <button 
                    id="nav-skills" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('skills')">
                    üîÆ Skills
                </button>
                <button 
                    id="nav-guide" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('guide')">
                    üìò Guide
                </button>
                <button 
                    id="nav-profile" 
                    class="btn bg-slate-600 text-white text-xs sm:text-sm" 
                    onclick="changeDashboardView('profile')">
                    ‚öôÔ∏è Profile
                </button>
            </div>


            <!-- Main Content Area -->
            <div id="main-dashboard-content" class="space-y-6">

                <!-- LOG & HISTORY VIEW (Default View) -->
                <div id="log-view-container">
                    
                    <!-- New Log/Filter Buttons -->
                    <div class="flex justify-between space-x-3 mb-4 p-0">
                         <button onclick="toggleLogForm()" class="btn bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 flex-grow">
                            üìù Log New Impulse
                        </button>
                         <button onclick="toggleLogFilter()" class="btn bg-slate-600 hover:bg-slate-500 text-white font-semibold py-3">
                            üóìÔ∏è Filter
                        </button>
                    </div>
                    
                    <!-- Impulse Log Form (Wrapped in a toggleable container) -->
                    <div id="log-form-container" class="app-card">
                        <form id="trigger-form" class="space-y-4 p-4 sm:p-6">
                            <h3 class="text-xl font-bold text-secondary mb-3">Record Your Impulse</h3>
                            
                            <label for="log-date" class="block text-sm font-medium text-text-light">When It Happened</label>
                            <input type="date" id="log-date" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                            
                            <label for="trigger-specific" class="block text-sm font-medium text-text-light">Trigger (What caused the urge?)</label>
                            <textarea id="trigger-specific" rows="2" placeholder="Describe the specific event: e.g., 'Scrolling my phone led to an urge.'" required class="w-full p-3 rounded-lg bg-slate-600 focus:ring-secondary focus:border-secondary transition duration-150 text-text-light text-body"></textarea>

                            <label for="log-thoughts" class="block text-sm font-medium text-text-light">Thoughts/Feelings during the urge</label>
                            <textarea id="log-thoughts" rows="2" placeholder="e.g., 'This is just one time', 'I deserve a break'" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body"></textarea>

                            <p class="text-sm font-medium text-text-light">Outcome</p>
                            <div id="action-taken-group" class="grid grid-cols-3 gap-2">
                                <input type="radio" id="action-resisted" name="log-action" value="Resisted" required class="hidden rating-input">
                                <label for="action-resisted" class="p-4 text-center rounded-lg bg-success hover:bg-success/80 transition cursor-pointer text-sm">I Won (Resisted)</label>
                                
                                <input type="radio" id="action-delayed" name="log-action" value="Delayed" class="hidden rating-input">
                                <label for="action-delayed" class="p-4 text-center rounded-lg bg-yellow-500 hover:bg-yellow-500/80 transition cursor-pointer text-sm">I Stalled (Delayed)</label>
                                
                                <input type="radio" id="action-gavein" name="log-action" value="Gave In" class="hidden rating-input">
                                <label for="action-gavein" class="p-4 text-center rounded-lg bg-danger hover:bg-danger/80 transition cursor-pointer text-sm">I Gave In</label>
                            </div>

                            <!-- Conditional Field: Shown only if 'Gave In' -->
                            <div id="gave-in-fields" class="space-y-4 p-3 bg-slate-800 rounded-lg hidden">
                                <label for="log-after-feelings" class="block text-sm font-medium text-text-light">If you Gave In: Aftermath</label>
                                <textarea id="log-after-feelings" rows="2" placeholder="e.g., 'Shameful, tired, and guilty'" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body"></textarea>
                            </div>
                            
                            <div id="resisted-fields">
                                <label for="log-tried-instead" class="block text-sm font-medium text-text-light">Positive Action Taken Instead</label>
                                <select id="log-tried-instead" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body">
                                    <option value="">Select Action...</option>
                                    <option value="Exercise">üèãÔ∏è Physical Exercise (Pushups, Run)</option>
                                    <option value="Contact">ü§ù Contact Support (Friend, Mentor)</option>
                                    <option value="Meditation">üßò Meditation/Prayer/Breathing</option>
                                    <option value="Blocker">üîí Used Blocker/Filtered Screen</option>
                                    <option value="Hobby">üé® Engaged in a Hobby (Reading, Writing)</option>
                                    <option value="Cleanup">üßπ Environment Cleanup/Organizing</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <button type="submit" class="w-full btn bg-primary hover:bg-primary/90 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-md shadow-primary/50">
                                Log Encounter
                            </button>
                        </form>
                    </div>

                    <!-- Log History -->
                    <div class="mt-6 p-0">
                        <h3 class="text-lg font-bold text-secondary mb-3 border-b border-slate-600 pb-2">Log History (Impulses & Battles)</h3>
                        
                        <!-- NEW: Advanced Filter Section (Hidden by Default) -->
                        <div id="log-filter-section" class="app-card p-4 mb-4 space-y-3 hidden">
                            <h4 class="text-base font-semibold text-primary">Date Range Filter</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="date-start-filter" class="block text-xs font-medium text-slate-400">Start Date</label>
                                    <input type="date" id="date-start-filter" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-sm" onchange="filterLogHistory()">
                                </div>
                                <div>
                                    <label for="date-end-filter" class="block text-xs font-medium text-slate-400">End Date</label>
                                    <input type="date" id="date-end-filter" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-sm" onchange="filterLogHistory()">
                                </div>
                            </div>
                            <button onclick="resetLogFilter()" class="btn bg-slate-500 hover:bg-slate-600 text-white py-2 px-4 rounded-xl text-xs">
                                Reset Filter
                            </button>
                        </div>

                        <div id="log-history" class="space-y-4">
                            <p class="text-slate-400 text-sm">No impulse logs recorded yet.</p>
                        </div>
                    </div>
                </div>

                <!-- BATTLE & QUEST VIEW -->
                <div id="battle-quest-container" class="space-y-6 hidden p-0">
                    
                    <!-- Monster Battle Log List (Active Encounters) -->
                    <div id="battle-log-list">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2">‚öîÔ∏è Active Encounters</h2>
                         <div id="monster-list" class="space-y-3">
                             <p class="text-slate-400 text-sm">No active monsters. Log an impulse!</p>
                         </div>
                    </div>
                    
                    <!-- NEW SECTION: ENCOUNTER HISTORY -->
                    <div id="encounter-history-list" class="mt-8">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2 text-primary">üìú Past Encounters (Completed/Lost)</h2>
                         <div id="monster-history-container" class="space-y-3">
                            <!-- History will be rendered here -->
                         </div>
                    </div>

                    <!-- Individual Active Battle View (Only shows when a battle is selected) -->
                    <div id="active-battle-view" class="hidden space-y-6">
                         <h2 class="text-xl font-bold mb-3 text-text-light border-b border-secondary/50 pb-2 flex justify-between items-center">
                            <span class="truncate text-lg sm:text-xl">Active Battle: <span id="active-battle-title" class="text-secondary"></span></span>
                            <button onclick="viewActiveBattle(null)" class="btn bg-slate-600 hover:bg-slate-700 text-xs py-2 px-3 rounded-xl ml-2 transition flex-shrink-0">
                                <span class="hidden sm:inline">Back to All Encounters</span>
                                <span class="sm:hidden">‚¨ÖÔ∏è Back</span>
                            </button>
                         </h2>

                        <!-- Monster Battle Section -->
                        <div id="battle-section" class="space-y-4 p-4 app-card">
                            <div id="monster-display" class="text-center space-y-2">
                                <!-- Monster content injected here -->
                            </div>

                            <!-- Power Bar -->
                            <div class="space-y-2">
                                <p class="text-lg font-semibold text-secondary flex justify-between items-center">
                                    <span id="power-text">üõ°Ô∏è Quests Completed Power: 0/100</span>
                                    <span id="weapon-text" class="text-sm text-slate-300"></span>
                                </p>
                                <div class="progress-bar-container">
                                    <div id="power-bar" class="progress-bar bg-yellow-500/80" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <!-- Attack Button (Now launches battle arena regardless of full power) -->
                            <button id="launch-battle-button" class="w-full btn bg-danger hover:bg-danger/90 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-md shadow-danger/50" onclick="launchTurnBasedBattle()">
                                üí• Launch Battle Arena
                            </button>

                            <p id="attack-status-message" class="text-sm text-yellow-400 text-center"></p>

                        </div>

                        <!-- Task List / Quest Log Section -->
                        <div id="quest-section">
                            <h2 class="text-xl font-bold mb-3 text-text-light border-b border-slate-600 pb-2">Quests to Gain Power</h2>
                            <div id="tasks-list" class="space-y-3">
                                <!-- Tasks injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: SKILLS & MOVES VIEW -->
                <div id="skills-view-container" class="space-y-6 hidden p-0">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">üîÆ Sentinel Skills & Moves</h2>
                    <p class="text-sm text-slate-400 text-body">Unlock permanent, powerful moves for the Arena by completing challenging, strategic tasks.</p>

                    <div id="player-skills-list" class="space-y-4">
                        <!-- Skills injected here -->
                    </div>
                </div>

                <!-- NEW: GUIDE VIEW -->
                <div id="guide-view-container" class="space-y-6 hidden p-0">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">üìò Sentinel Guide: Master the Impulse</h2>
                    
                    <div id="mystery-man-guide" class="app-card p-4 space-y-4">
                        <div class="flex items-center space-x-3 bg-slate-700 p-3 rounded-lg">
                            <span class="text-4xl">üé©</span>
                            <h3 class="text-xl font-bold text-secondary">The Guide's Wisdom</h3>
                        </div>
                        <div class="relative w-full overflow-hidden rounded-lg shadow-xl" style="padding-top: 56.25%"> 
    <iframe
        src="https://www.youtube-nocookie.com/embed/waRe8h6Pki8?rel=0"
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
        allowfullscreen
        class="absolute top-0 left-0 w-full h-full"
        referrerpolicy="strict-origin-when-cross-origin"
    ></iframe>
</div>
                        <p class="text-text-light text-body">Welcome, Warrior! This game helps you fight bad habits by turning them into fun challenges. Here's how to win the battle against impulse:</p>

                        <div class="space-y-4">
                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-primary">
                                <h4 class="font-bold text-text-light">1. Log the Urge (Mission Report)</h4>
                                <p class="text-sm text-slate-400 mt-1 text-body">When you feel an urge, go to the **üìù Log** tab immediately. **Record** what happened. This action creates a **Monster** in the Battle tab, determined by your reported trigger.</p>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-secondary">
                                <h4 class="font-bold text-text-light">2. Complete the Quests (Gain Power)</h4>
                                <p class="text-sm text-slate-400 mt-1 text-body">The Monster's Health shows how strong the urge is. To weaken it, check the **‚öîÔ∏è Battles** tab and complete the easy **Quests** (Physical, Mental, Emotional, Dietary, Protection, and Strategic tasks). Finish a quest, click **"Submit Proof,"** and you gain **Power**.</p>
                                <p class="text-xs text-yellow-400 mt-1 text-body">**Quests Breakdown:** The variety helps build holistic defenses. **Protection** is for immediate defense, and **Strategy** is for future prevention. **Proof:** Send a quick photo/video (File Proof) or write a short summary (Text Proof).</p>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-success">
                                <h4 class="font-bold text-text-light">3. Fight the Monster (The Final Stand)</h4>
                                <p class="text-sm text-slate-400 mt-1 text-body">Once you have enough **Power** (usually 100+), launch the **Impulse Battle Arena**! Use **Strike** (Willpower) to attack and **Guard** (Focus) to defend/use Mental Skills. Win, and you gain **XP** and level up. Lose, and your Power resets, but the Monster keeps its damage.</p>
                            </div>
                            
                            <div class="p-3 bg-slate-800 rounded-lg border-l-4 border-danger">
                                <h4 class="font-bold text-font-light">4. Grow Your Skills</h4>
                                <p class="text-sm text-slate-400 mt-1 text-body">Use your **XP** in the **üîÆ Skills** tab to learn powerful new moves that help you win future battles. Every Level Up permanently increases your core stats!</p>
                            </div>
                        </div>

                        <p class="text-sm text-slate-400 pt-3 border-t border-slate-700 italic text-body">May your resolve be unbreakable, Sentinel. You can always check the Guide!</p>
                    </div>
                </div>

                <!-- NEW: PROFILE VIEW (Was SETTINGS) -->
                <div id="profile-view-container" class="space-y-6 hidden p-0">
                    <h2 class="text-xl font-bold text-primary border-b border-slate-600 pb-2">‚öôÔ∏è Your Profile</h2>
                    <p class="text-sm text-slate-400 text-body">Edit your Warrior profile details.</p>

                    <div class="app-card p-4 space-y-4">
                        <div class="flex justify-between items-center border-b border-slate-600 pb-3 mb-3">
                            <h3 class="text-lg font-bold text-secondary">Profile Details</h3>
                            <button type="button" id="edit-profile-btn" onclick="toggleSettingsEdit(true)" class="btn bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-4 rounded-xl transition duration-200">
                                üìù Edit Details
                            </button>
                        </div>
                        <form id="settings-form" class="space-y-4">
                            
                            <!-- Fields for Name and Phone are still here, but no longer 'private' labeled -->
                            <label for="settings-real-name" class="block text-sm font-medium text-text-light">Your Name</label>
                            <input type="text" id="settings-real-name" required class="w-full p-3 rounded-lg bg-slate-600 text-text-light opacity-70 cursor-not-allowed text-body" disabled>

                            <label for="settings-phone" class="block text-sm font-medium text-text-light">Phone Number</label>
                            <input type="tel" id="settings-phone" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full p-3 rounded-lg bg-slate-600 text-text-light opacity-70 cursor-not-allowed text-body" disabled>

                            <!-- Editable Fields -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="settings-age" class="block text-sm font-medium text-text-light">Age</label>
                                    <input type="number" id="settings-age" min="15" max="100" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body" disabled>
                                </div>
                                <div>
                                    <label for="settings-gender" class="block text-sm font-medium text-text-light">Gender</label>
                                    <input type="text" id="settings-gender" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body" disabled>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="settings-city" class="block text-sm font-medium text-text-light">City</label>
                                    <input type="text" id="settings-city" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body" disabled>
                                </div>
                                
                                <!-- Source is read-only input showing the selected value -->
                                <div>
                                    <label for="settings-source" class="block text-sm font-medium text-text-light">How did you find us</label>
                                    <input type="text" id="settings-source" class="w-full p-3 rounded-lg bg-slate-600 text-text-light text-body" disabled>
                                </div>
                            </div>
                            
                            <button type="submit" id="settings-save-btn" class="w-full btn bg-success hover:bg-success/90 text-white font-semibold py-3 rounded-xl transition duration-200 mt-4 hidden">
                                Save Changes
                            </button>
                            <button type="button" id="settings-cancel-btn" onclick="toggleSettingsEdit(false)" class="w-full btn bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl transition duration-200 mt-2 hidden">
                                Cancel Edit
                            </button>
                        </form>
                    </div>

                    <!-- Contact/Support Section - Updated with icons (BORDER REMOVED) -->
                    <div class="p-4 app-card text-center space-y-3">
                        <h3 class="text-lg font-bold text-secondary">Need Immediate Support?</h3>
                        <p class="text-sm text-text-light text-body">Connect with us for urgent support or bug reports.</p>
                        
                        <div class="flex justify-center space-x-6">
                            
                            <!-- Call Link -->
                            <a href="tel:+918652239152" class="flex flex-col items-center text-success hover:text-success/80 transition duration-200">
                                <span class="text-4xl mb-1">üìû</span>
                                <span class="text-sm font-extrabold">+918652239152</span>
                            </a>
                            
                            <!-- WhatsApp Link -->
                            <a href="https://wa.me/918652239152" target="_blank" class="flex flex-col items-center text-success hover:text-success/80 transition duration-200">
                                <span class="text-4xl mb-1">üí¨</span>
                                <span class="text-sm font-extrabold">WhatsApp Chat</span>
                            </a>
                        </div>
                        <p class="text-xs text-slate-400 mt-3 text-body">Support available 24/7.</p>
                    </div>

                </div>
            
            <!-- 4. Outcome Message Box (For win/loss/instructions) -->
            <div id="message-box" class="p-4 rounded-xl text-center shadow-lg transition duration-300 hidden">
                <p id="message-text" class="text-lg font-medium text-body"></p>
                <button id="reset-button" onclick="resetGame()" class="mt-4 btn bg-success hover:bg-success/90 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 hidden">
                    Start a New Battle
                </button>
            </div>

        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR DEPLOYED GOOGLE SCRIPT URL FOR DATA LOGGING
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzH_LnFvhbixp_IbaInbj-p6Z-IYH67VOySkFU8XusOhtwlhjWn6iuqJ21OhKRRSWmp0g/exec'; 
        // ‚û°Ô∏è 1. ADD YOUR PUBLIC YOUTUBE VIDEO ID HERE
        const GUIDE_VIDEO_ID = 'waRe8h6Pki8'; 
        // Example: const GUIDE_VIDEO_ID = 'dQw4w9WgXcQ';
        // --- Persistence Keys ---
        const PROGRESS_KEY = 'addiction_fighter_progress'; // Monster progression wins
        const CHARACTER_KEY = 'addiction_fighter_character'; // User profile and base stats
        const LOG_HISTORY_KEY = 'addiction_fighter_logs'; // Stores all detailed log entries
        const SKILLS_KEY = 'addiction_fighter_skills'; // Stores unlocked player skills'

        // --- BATTLE ARENA STATE (MUST BE DECLARED GLOBALLY FIRST) ---
        let battleArenaState = {
            currentMonsterLog: null,
            monsterCurrentHP: 0,
            playerCurrentHP: 0,
            isPlayerTurn: true,
            isLocked: false, // For effects like Silent Shackles (Skill based only now)
            playerDefending: false,
            playerWillpowerModifier: 0, // Temporary debuff (Lower Willpower)
            playerFocusModifier: 0,    // Temporary debuff (Lower Focus)
        };
        
        // --- DATA LOGGING FUNCTIONS (MUST BE DECLARED GLOBALLY FIRST) ---
        
        /**
         * Sends data to a deployed Google Script Web App URL.
         * @param {Object} data The payload to send (e.g., char data, log data).
         * @param {string} sheetName The name of the sheet to record data (e.g., 'Profile', 'Logs').
         */
        async function logDataToSheet(data, sheetName) {
            if (GOOGLE_SHEET_URL.includes('YOUR_GOOGLE_SCRIPT_WEB_APP_URL')) {
                console.warn(`[Sheet Logging] Skipped: Please set GOOGLE_SHEET_URL in the script.`);
                return;
            }

            const payload = {
                action: 'logData',
                sheet: sheetName,
                data: {
                    ...data,
                    timestamp: new Date().toISOString()
                }
            };

            try {
                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Script POST requests
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                // Note: Since mode is 'no-cors', response status checks are often unreliable.
                console.log(`[Sheet Logging] Data sent to ${sheetName}. Response (may be opaque):`, response);
            } catch (error) {
                console.error(`[Sheet Logging] Failed to send data to ${sheetName}:`, error);
            }
        }


        // --- Configuration: Tasks (SIX CATEGORIES: Physical, Mental, Emotional, Dietary, STRATEGY, PROTECTION - 25 each) ---
        const ALL_QUEST_CATEGORIES = {
            // 1. Physically Active Tasks (Physical)
            'PHYSICAL': [
                { id: 'physical_stretch_15', name: 'ü§∏ 15 Min Stretching/Light Cardio', value: 25, description: 'Change your physical state to reset your mental state.', instructions: 'Engage in 15 continuous minutes of non-strenuous physical activity. Break the static state.', proof: 'File Proof: A photo of you stretching, or a screenshot of a 15-minute timer/fitness app activity log.' },
                { id: 'physical_pushups_10', name: 'üí™ 10 Push-ups or 20 Squats', value: 20, description: 'Immediate, high-intensity physical interruption.', instructions: 'Complete 10 push-ups or 20 squats to force adrenaline and change blood flow.', proof: 'Text Proof: State which exercise you did and the number of repetitions completed.' },
                { id: 'physical_walk_15', name: 'üëü 15 Min Outdoor Walk', value: 35, description: 'Expose yourself to sunlight and environment.', instructions: 'Step outside and walk for 15 minutes without looking at your phone.', proof: 'File Proof: A quick photo of your walking environment (street, park, nature).' },
                { id: 'physical_clean_10', name: 'üßπ Tidy up One Area for 10 Minutes', value: 20, description: 'Combines physical movement with environment control.', instructions: 'Set a timer for 10 minutes and actively clean/organize one small, designated area.', proof: 'File Proof: Submit a photo of the area *after* it has been tidied.' },
                { id: 'physical_dance_5', name: 'üï∫ 5 Minutes of Energetic Movement', value: 30, description: 'Release endorphins and break negative thought patterns through movement.', instructions: 'Put on upbeat music and dance or shake out your body for 5 straight minutes.', proof: 'Text Proof: State the song/artist you danced to and how your body feels now.' },
                { id: 'physical_desk_pushup', name: 'üèãÔ∏è 5 Sets of Desk Push-ups', value: 10, description: 'Quick muscle engagement to clear mental fog.', instructions: 'Complete 5 sets of wall or desk push-ups (10 reps each).', proof: 'Text Proof: State the total number of reps achieved.' },
                { id: 'physical_stairs_3x', name: '‚õ∞Ô∏è Climb 3 Flights of Stairs (3x)', value: 30, description: 'Short burst of cardio to alter mood.', instructions: 'Walk briskly up and down 3 flights of stairs, completing the cycle three times.', proof: 'Text Proof: State the time you started and finished the exercise.' },
                { id: 'physical_clean_dishes', name: 'üçΩÔ∏è Wash a Sink Full of Dishes', value: 25, description: 'Mindful, purposeful manual labor.', instructions: 'Fully clear, wash, and dry a sink full of dirty dishes.', proof: 'File Proof: A photo of the empty, clean sink.' },
                { id: 'physical_sun_gaze_1', name: '‚òÄÔ∏è Stand in the Sun for 1 Minute', value: 15, description: 'Increase Vitamin D exposure and grounding.', instructions: 'Stand outside or by a window for 60 seconds, feeling the sunlight on your skin.', proof: 'Text Proof: State the minute you completed this task.' },
                { id: 'physical_power_pose', name: 'ü¶∏ Power Pose for 2 Minutes', value: 15, description: 'Use body language to influence mood and confidence.', instructions: 'Hold a confident, expansive posture (hands on hips, arms raised) for two minutes.', proof: 'Text Proof: Describe the pose you held and how you felt afterward.' },
                { id: 'physical_jump_jacks_50', name: 'ü§∏‚Äç‚ôÇÔ∏è 50 Jumping Jacks', value: 20, description: 'Fast, high-impact interruption to the impulse.', instructions: 'Complete 50 continuous jumping jacks.', proof: 'Text Proof: State the time taken to complete 50 repetitions.' },
                { id: 'physical_water_walk_10', name: 'üö∂ Mindful Water/Forest Walk (10 min)', value: 30, description: 'Nature exposure combined with sensory grounding.', instructions: 'Take a 10-minute walk focusing only on the sounds and sights around you.', proof: 'Text Proof: List two specific things you saw or heard on the walk.' },
                { id: 'physical_organize_closet', name: 'üëï Organize One Closet Drawer', value: 40, description: 'Productive, detailed, physical task.', instructions: 'Completely empty, refold, and re-organize a single drawer or shelf.', proof: 'File Proof: A photo of the organized drawer.' },
                { id: 'physical_sit_stand_10', name: 'ü™ë 10 Sit-to-Stands', value: 15, description: 'Simple leg strength and movement.', instructions: 'Perform 10 sit-to-stands without using your hands for balance.', proof: 'Text Proof: Confirm completion and briefly describe your current energy level.' },
                { id: 'physical_dust_room', name: '‚ú® Dust & Wipe Down One Room', value: 25, description: 'Focus on environmental control and cleanliness.', instructions: 'Dust all surfaces and wipe down one full room (e.g., bedroom, office).', proof: 'Text Proof: Name the room you dusted and wiped down.' },
                { id: 'physical_yoga_15', name: 'üßò‚Äç‚ôÄÔ∏è 15 Min Beginner Yoga Routine', value: 35, description: 'Stretching and controlled movement for mind-body connection.', instructions: 'Follow a 15-minute beginner yoga routine (use a video guide if needed).', proof: 'Text Proof: Name one pose you held during the session.' },
                { id: 'physical_heavy_lift', name: 'üì¶ Move Something Heavy 5 Times', value: 30, description: 'Overcoming mental inertia with physical effort.', instructions: 'Safely lift and move a heavy, non-fragile object (e.g., a backpack, box, piece of furniture) 5 times.', proof: 'Text Proof: Name the object and confirm the number of repetitions.' },
                { id: 'physical_outdoor_air', name: 'üå¨Ô∏è Deep Breathing Outside (5 mins)', value: 15, description: 'Combining movement and focused breathwork.', instructions: 'Go outside for 5 minutes and practice slow, deep, diaphragmatic breathing.', proof: 'Text Proof: Describe the quality of the air and how your shoulders felt.' },
                { id: 'physical_wall_sit_1', name: 'ü¶µ Hold a Wall Sit for 60 Seconds', value: 25, description: 'Intense physical distraction.', instructions: 'Hold a static wall sit (knees at 90 degrees) for a full 60 seconds.', proof: 'File Proof: A photo of your timer showing 1:00 completed.' },
                { id: 'physical_tidy_digital', name: 'üóëÔ∏è Delete 20 Unnecessary Phone Photos', value: 15, description: 'Physical action of clearing digital clutter.', instructions: 'Go into your phone gallery and delete 20 photos or screenshots you do not need.', proof: 'Text Proof: Confirm the completion of the photo deletion.' },
                { id: 'physical_hand_stretch', name: 'üñêÔ∏è Wrist & Hand Stretches (3 min)', value: 10, description: 'Relieves tension held in the hands and wrists.', instructions: 'Perform wrist circles and hand stretches for 3 continuous minutes.', proof: 'Text Proof: State which hand felt the most tension before the exercise.' },
                { id: 'physical_errand_walk', name: 'üö∂‚Äç‚ôÄÔ∏è Complete a Small Errand on Foot', value: 20, description: 'Combine necessary tasks with movement.', instructions: 'Walk to a nearby shop/mailbox to complete a required small errand.', proof: 'Text Proof: Name the errand completed and estimate the distance walked.' },
                { id: 'physical_window_clean', name: 'ü™ü Clean Three Windows', value: 30, description: 'Physical effort with visible, rewarding outcome.', instructions: 'Clean the interior and exterior of three windows until spotless.', proof: 'File Proof: A photo showing a clean window and the cleaning tools.' },
                { id: 'physical_sort_recycling', name: '‚ôªÔ∏è Organize and Take Out Recycling', value: 15, description: 'Physical completion of a pending chore.', instructions: 'Sort all current recycling and take the container out to the designated area.', proof: 'Text Proof: Confirm the recycling has been successfully taken out.' },
                { id: 'physical_laundry_fold', name: 'üß∫ Fold & Put Away Laundry', value: 25, description: 'Finishing a cycle of productive chores.', instructions: 'Fold and put away one full basket of clean laundry in its designated spot.', proof: 'Text Proof: Confirm the location of the put-away laundry (e.g., "all shirts are in the dresser").' },
            ],
            // 2. Mentally Focused Tasks (Mental)
            'MENTAL': [
                { id: 'mental_problem_5', name: 'üß† Solve a Sudoku or Math Problem', value: 30, description: 'Engage the prefrontal cortex with a structured task.', instructions: 'Spend 5-10 minutes on a logic puzzle, math problem, or learning 5 new foreign words.', proof: 'Text Proof: State the puzzle/topic and one specific thing you solved or learned.' },
                { id: 'mental_journal_50', name: '‚úçÔ∏è Write 50 Words on a Neutral Topic', value: 25, description: 'Practice disciplined, focused output.', instructions: 'Write 50 words about a completely neutral topic (e.g., the history of coffee, how a pencil is made, etc.).', proof: 'Text Proof: Paste the short paragraph you wrote.' },
                { id: 'mental_delay_15', name: '‚è±Ô∏è Delay Action for 15 Minutes', value: 30, description: 'Prove that the urge is temporary and resistible by setting a timer.', instructions: 'Immediately set a timer for 15 minutes. During this time, read a book or perform a simple, non-impulsive chore.', proof: 'File Proof: A screenshot of the 15-minute timer successfully completed.' },
                { id: 'mental_plan_day', name: 'üìÖ Plan the Next Hour of Your Day', value: 20, description: 'Regain control by structuring immediate time.', instructions: 'Break down the next 60 minutes into 3-4 specific, non-impulsive tasks and complete the first one.', proof: 'Text Proof: List the 3-4 tasks you planned.' },
                { id: 'mental_read_10', name: 'üìö Read an Article or Book Chapter (10 mins)', value: 25, description: 'Displace mental energy towards constructive learning or narrative.', instructions: 'Read a physical book or a long-form article for at least 10 continuous minutes.', proof: 'Text Proof: State the title of the material and one new fact you learned.' },
                { id: 'mental_learn_knot', name: 'ü™¢ Learn a New Practical Skill (Knot)', value: 20, description: 'Focuses concentration on tactile and visual instruction.', instructions: 'Watch a short tutorial and practice tying one new knot (e.g., square knot, slip knot).', proof: 'File Proof: Photo of the successfully tied knot.' },
                { id: 'mental_write_goal', name: 'üéØ Write Down 1 Goal & 3 Steps', value: 15, description: 'Future-focused planning to counter short-term impulse.', instructions: 'Write down one long-term personal goal and three small, immediate steps towards achieving it.', proof: 'Text Proof: List the goal and the three steps.' },
                { id: 'mental_listen_podcast', name: 'üéôÔ∏è Listen to a Short Educational Podcast', value: 25, description: 'Passive learning to occupy the mind without screen interaction.', instructions: 'Listen to a short (10-15 minute) educational podcast on a topic you are unfamiliar with.', proof: 'Text Proof: State the topic and one new concept you learned.' },
                { id: 'mental_memory_list', name: 'üìù Memorize a List of 10 Words', value: 15, description: 'Sharpens short-term memory and focus.', instructions: 'Generate 10 random words and spend 5 minutes trying to memorize them, then write them down.', proof: 'Text Proof: Write down the 10 words from memory.' },
                { id: 'mental_no_social_30', name: 'üö´ Block Social Media (30 Min)', value: 35, description: 'Active prevention against digital triggers.', instructions: 'Use a blocker or physical discipline to avoid all social media platforms for 30 consecutive minutes.', proof: 'File Proof: A screenshot of the active timer or blocker app.' },
                { id: 'mental_budget_check', name: 'üí∞ Review 3 Days of Spending', value: 30, description: 'Financial mindfulness to curb impulse spending thoughts.', instructions: 'Review your bank statements or budget app for the last 72 hours.', proof: 'Text Proof: State the most impulsive purchase you identified.' },
                { id: 'mental_crossword', name: '‚úèÔ∏è Complete a Mini Crossword/Logic Puzzle', value: 20, description: 'Engages verbal and logical reasoning centers.', instructions: 'Complete a small, accessible crossword or logic puzzle (online or physical).', proof: 'Text Proof: State the final word/solution of the puzzle.' },
                { id: 'mental_new_route', name: 'üó∫Ô∏è Plan a New Route (5 min)', value: 15, description: 'Spatial reasoning exercise to distract the mind.', instructions: 'Use a map app to plan a completely new route to a known destination (work, store, gym).', proof: 'Text Proof: Name the starting and ending point and the new distance.' },
                { id: 'mental_fix_bug', name: 'üíª Fix a Small Code/Project Bug (15 min)', value: 40, description: 'Engages problem-solving skills on a productive task.', instructions: 'Spend 15 minutes troubleshooting a non-critical technical issue or a personal code bug.', proof: 'Text Proof: Describe the bug and the resolution attempt.' },
                { id: 'mental_read_wiki', name: 'üåê Read a Random Wikipedia Article (10 min)', value: 20, description: 'Introduces novelty and structured reading.', instructions: 'Click "Random Article" on Wikipedia and read the content for 10 minutes.', proof: 'Text Proof: State the name of the random article and its main subject.' },
                { id: 'mental_review_log', name: 'üìù Review 3 Past Log Entries', value: 15, description: 'Self-reflection and pattern recognition.', instructions: 'Go to your Log History and read your three most recent entries, identifying one common trigger or thought pattern.', proof: 'Text Proof: State the common trigger/pattern you identified.' },
                { id: 'mental_email_clean', name: 'üìß Delete 50 Old Emails', value: 25, description: 'Clearing mental and digital baggage.', instructions: 'Go through your inbox and delete/archive 50 old, unnecessary emails.', proof: 'Text Proof: State the number of emails remaining in your primary inbox.' },
                { id: 'mental_creative_write', name: 'üé≠ Write a Short Haiku or Flash Fiction', value: 30, description: 'Engages creativity to bypass rumination.', instructions: 'Write one Haiku (5, 7, 5 syllables) or a very short, original story (max 5 sentences).', proof: 'Text Proof: Paste the creative work you generated.' },
                { id: 'mental_math_calc', name: 'üî¢ Mental Calculation Challenge', value: 15, description: 'Forces immediate, sharp concentration.', instructions: 'Mentally calculate 18% of 95, or a similar complex number task.', proof: 'Text Proof: State the math problem and your calculated answer.' },
                { id: 'mental_new_recipe', name: 'üç≤ Research a New Healthy Recipe', value: 20, description: 'Planning for future positive action.', instructions: 'Find one new low-budget, healthy recipe online and purchase one new required ingredient.', proof: 'File Proof: A photo of the new ingredient purchased.' },
                { id: 'mental_language_app', name: 'üó£Ô∏è Language Learning App (10 min)', value: 25, description: 'Dedicated focus on cognitive skill building.', instructions: 'Spend 10 minutes working on lessons in a language learning app (e.g., Duolingo).', proof: 'File Proof: Screenshot of your app progress after the 10 minutes.' },
                { id: 'mental_brainstorm_5', name: '‚úçÔ∏è Brainstorm 5 Alternative Activities', value: 15, description: 'Pre-emptive strategy development.', instructions: 'Write down five alternative, non-impulsive activities you could have done instead of engaging the trigger.', proof: 'Text Proof: List the 5 alternative activities.' },
                { id: 'mental_organize_desktop', name: 'üñ•Ô∏è Clean Up Computer Desktop', value: 20, description: 'Achieving order in the digital workspace.', instructions: 'Organize desktop files into folders and delete old documents from your computer desktop.', proof: 'File Proof: A screenshot of your clean desktop background.' },
                { id: 'mental_timer_5_min', name: '‚è±Ô∏è Focus on ONE Task (5 min)', value: 30, description: 'Micro-dose of highly disciplined, focused work.', instructions: 'Work *only* on a pending difficult task for 5 minutes without checking your phone or switching apps.', proof: 'Text Proof: Name the task and what you achieved in the 5 minutes.' },
                { id: 'mental_research_skill', name: 'üîç Find 3 Resources for a New Skill', value: 25, description: 'Initiating professional or personal development.', instructions: 'Identify a skill you want to learn (coding, drawing, cooking) and find three instructional resources (books, videos, courses).', proof: 'Text Proof: List the skill and the three resources found.' },
            ],
            // 3. Emotionally Regulating Tasks (Emotional)
            'EMOTIONAL': [
                { id: 'emotional_breath_5', name: 'üå¨Ô∏è 5 Minutes of Box Breathing', value: 25, description: 'Regulate heart rate and ground the mind in the present moment.', instructions: 'Perform box breathing (inhale 4, hold 4, exhale 4, hold 4) for 5 consecutive minutes.', proof: 'Text Proof: State the time you completed the breathing exercise and how you felt afterward (e.g., 5 min, calmer).' },
                { id: 'emotional_reach_out', name: 'ü§ù Contact 1 Trusted Person', value: 20, description: 'Break the isolation spiral and strengthen your support network.', instructions: 'Reach out via text or phone call to a friend, family member, or mentor. Focus on genuine connection, not your impulse.', proof: 'Text Proof: Submit the name (or initial) of the person you contacted, and briefly state the purpose of the communication.' },
                { id: 'emotional_gratitude_3', name: 'üôè List 3 Things You Are Grateful For', value: 15, description: 'Shift focus from deficit to abundance.', instructions: 'Write down three specific things that happened today or recently that you are genuinely grateful for.', proof: 'Text Proof: List the three items you wrote down.' },
                { id: 'emotional_senses_5', name: 'üñêÔ∏è 5-4-3-2-1 Grounding Technique', value: 30, description: 'Anchor yourself in the present reality.', instructions: 'List 5 things you can see, 4 things you can touch, 3 things you can hear, 2 things you can smell, and 1 thing you can taste.', proof: 'Text Proof: List the items you used for one of the categories (e.g., the 5 things you saw).' },
                { id: 'emotional_music', name: 'üéß Listen to Calming Music (5 mins)', value: 10, description: 'Use auditory input to soothe the nervous system.', instructions: 'Listen to a pre-selected calming playlist or classical music track for at least 5 minutes.', proof: 'Text Proof: State the track or artist you listened to and describe the mood change.' },
                { id: 'emotional_express_anger', name: 'üò° Write an Anger Letter (Do Not Send)', value: 20, description: 'Safe emotional expression and release.', instructions: 'Write a short letter (2-3 paragraphs) expressing your frustration or anger towards a situation or person (do not send, delete or burn it afterward).', proof: 'Text Proof: Write a single sentence reflecting on the relief gained from writing the letter.' },
                { id: 'emotional_kindness_act', name: 'üòá Perform 1 Small Act of Kindness', value: 25, description: 'Focuses energy outward, boosting self-worth.', instructions: 'Send a compliment, hold a door, offer a small help, or leave a nice note for someone.', proof: 'Text Proof: Describe the act of kindness you performed.' },
                { id: 'emotional_self_compassion', name: 'üíñ Write 1 Self-Compassion Sentence', value: 15, description: 'Counteracts shame and self-criticism.', instructions: 'Write one kind, compassionate sentence directed towards yourself, acknowledging difficulty.', proof: 'Text Proof: Paste the self-compassion sentence.' },
                { id: 'emotional_cuddle_pet', name: 'üêï Cuddle a Pet or Pillow (5 min)', value: 20, description: 'Releases oxytocin through touch.', instructions: 'Spend 5 minutes mindfully cuddling a pet, a loved one, or a soft item like a pillow or blanket.', proof: 'Text Proof: Describe the feeling of comfort achieved.' },
                { id: 'emotional_safe_place', name: 'üåå Visualize a Safe Place (5 min)', value: 30, description: 'Mindful retreat and emotional stabilization.', instructions: 'Close your eyes and mentally visualize your safest, calmest place in vivid detail for 5 minutes.', proof: 'Text Proof: Describe the setting of your safe place (e.g., "A sunny beach with warm sand").' },
                { id: 'emotional_temperature', name: '‚ùÑÔ∏è Apply Cold to Neck (1 min)', value: 20, description: 'Uses temperature to interrupt emotional intensity (TIPP skill).', instructions: 'Apply a cold pack or ice cube wrapped in a cloth to the back of your neck for 60 seconds.', proof: 'Text Proof: Describe the shock/change in feeling.' },
                { id: 'emotional_call_support', name: 'üìû Text/Call a Support/Crisis Line', value: 40, description: 'High-power quest for moments of severe emotional distress.', instructions: 'Reach out to a professional or crisis line if feeling severely overwhelmed or unsafe.', proof: 'Text Proof: Confirm the contact was made (No personal details required).' },
                { id: 'emotional_affirmation', name: 'üó£Ô∏è Repeat Positive Affirmation (10x)', value: 15, description: 'Resets negative self-talk.', instructions: 'Repeat a chosen positive affirmation (e.g., "I am strong," "I choose health") 10 times aloud.', proof: 'Text Proof: State the affirmation used.' },
                { id: 'emotional_cry', name: 'üò¢ Allow Yourself to Cry (5 min)', value: 35, description: 'Acceptance and non-judgmental release of tension.', instructions: 'If you feel the urge to cry, allow yourself to release tension for 5 minutes without stopping the feeling.', proof: 'Text Proof: State the emotion that was released.' },
                { id: 'emotional_help_friend', name: 'üôã Offer Help to a Friend', value: 30, description: 'Shifts focus from personal distress to external support.', instructions: 'Call or text a friend and ask them if you can help them with one small task or offer to listen to their problems.', proof: 'Text Proof: Describe the small help you offered.' },
                { id: 'emotional_child_photo', name: 'üë∂ Comfort Your Inner Child (5 min)', value: 20, description: 'Practices compassion for past wounds.', instructions: 'Look at a photo of yourself as a child and offer a few words of comfort and unconditional acceptance.', proof: 'Text Proof: Write down one sentence of comfort offered.' },
                { id: 'emotional_scent_anchor', name: 'üëÉ Smell a Strong, Positive Aroma', value: 15, description: 'Mindful sensory experience to break dissociation.', instructions: 'Find a strong, pleasant scent (e.g., coffee, perfume, essential oil) and focus on smelling it for 1 minute.', proof: 'Text Proof: Name the smell and its intensity.' },
                { id: 'emotional_write_why', name: 'üìù Write "Why I Deserve Recovery" (5 min)', value: 25, description: 'Reinforces core values and motivation.', instructions: 'Write down a continuous stream of consciousness on the topic "Why I deserve recovery" for 5 minutes.', proof: 'Text Proof: Summarize the main reason in one sentence.' },
                { id: 'emotional_mirror_talk', name: 'üòÅ Look in Mirror and Smile (30 sec)', value: 15, description: 'Changes facial physiology to signal positive emotion to the brain.', instructions: 'Look directly in the mirror, smile widely, and hold the smile for 30 seconds.', proof: 'Text Proof: Describe your facial expression before and after the 30 seconds.' },
                { id: 'emotional_watch_comedy', name: 'ü§£ Watch a Short Comedy Clip', value: 20, description: 'Uses humor to shift mood.', instructions: 'Watch a funny video (under 3 minutes) or comedy stand-up clip.', proof: 'Text Proof: State one specific moment that made you laugh.' },
                { id: 'emotional_light_candle', name: 'üïØÔ∏è Light a Candle or Soft Light', value: 25, description: 'Creates a calming, ritualistic atmosphere.', instructions: 'Light a candle (safely) or turn off harsh lighting and use a softer light source for 10 minutes.', proof: 'Text Proof: Describe the change in atmosphere.' },
                { id: 'emotional_positive_review', name: '‚≠ê Write a Positive Online Review', value: 15, description: 'External focus on generating positivity for others.', instructions: 'Write a genuine, positive online review for a local business or product you appreciate.', proof: 'Text Proof: Name the entity you reviewed.' },
                { id: 'emotional_body_scan', name: 'üßò Body Scan Meditation (5 mins)', value: 30, description: 'Mindfulness practice to observe and accept physical sensations without judgment.', instructions: 'Perform a full body scan meditation for at least 5 minutes, focusing on tension and relaxation in each body part.', proof: 'Text Proof: Name the area where you held the most tension.' },
                { id: 'emotional_vent_voice', name: 'üéôÔ∏è Record a 3-Minute Voice Memo Rant', value: 25, description: 'Private, non-destructive emotional catharsis.', instructions: 'Record a voice memo ranting or venting about your feelings for 3 minutes, then immediately delete the file.', proof: 'Text Proof: State the duration and the feeling released.' },
                { id: 'emotional_water_hands', name: 'üíß Run Hands Under Water (1 min)', value: 10, description: 'Sensory grounding using temperature and flow.', instructions: 'Run your hands under cool or warm water, focusing only on the sensation, for 1 full minute.', proof: 'Text Proof: Describe the temperature and feeling of the water.' },
            ],
            // 4. Low Budget Healthy Food/Dietary Tasks (Dietary)
            'DIETARY': [
                { id: 'dietary_water_500', name: 'üíß Drink 500ml Water/Unsweetened Tea', value: 10, description: 'Hydrate immediately to address subtle fatigue or dehydration.', instructions: 'Drink two standard cups (500ml) of plain water or unsweetened herbal tea.', proof: 'Text Proof: State the time you drank the water and briefly describe how it made you feel.' },
                { id: 'dietary_fruit_veg', name: 'üçé Eat a Low-Budget Fruit or Vegetable', value: 15, description: 'Satisfy oral fixation and blood sugar dip with healthy fuel.', instructions: 'Eat one apple, banana, carrot, or handful of inexpensive nuts/seeds (e.g., peanuts).', proof: 'File Proof: A photo of the fruit/vegetable you are eating.' },
                { id: 'dietary_protein_snack', name: 'ü•ö Eat a Low-Cost Protein Snack', value: 25, description: 'Stabilize energy with complex proteins.', instructions: 'Eat 1-2 hard-boiled eggs, a spoonful of peanut butter, or a piece of cheese/yogurt.', proof: 'Text Proof: State the protein source you consumed and the time.' },
                { id: 'dietary_prep_meal', name: 'üî™ Prep 1 Healthy Meal Component', value: 35, description: 'Future-proof your diet by prepping healthy ingredients.', instructions: 'Spend 10 minutes washing, chopping, or packaging vegetables/grains for a future low-cost healthy meal.', proof: 'File Proof: A photo of the prepped ingredient(s).' },
                { id: 'dietary_tea_warm', name: '‚òï Make/Drink Warm Herbal Tea', value: 15, description: 'The ritual of preparation acts as a mindful anchor.', instructions: 'Make a cup of herbal tea (no sugar) and drink it slowly, focusing on the warmth and scent.', proof: 'Text Proof: State the type of tea and one adjective to describe the smell.' },
                { id: 'dietary_veg_chop_1', name: 'ü•ï Chop One Vegetable for Future Use', value: 20, description: 'Mindful preparation to promote better future eating.', instructions: 'Chop one vegetable (onion, carrot, cucumber) and store it in the fridge for a meal tomorrow.', proof: 'File Proof: A photo of the chopped and stored vegetable.' },
                { id: 'dietary_sip_slow_2', name: 'üíß Slowly Sip Water (2 Min)', value: 10, description: 'Mindful hydration to slow down internal processes.', instructions: 'Take a small glass of water and make it last for 2 minutes, focusing on the taste and texture.', proof: 'Text Proof: Confirm the duration of the slow sipping.' },
                { id: 'dietary_fiber_snack', name: 'üçû Eat a Fiber-Rich Snack', value: 20, description: 'Satiety and long-lasting energy.', instructions: 'Eat a small snack high in fiber (e.g., a small bowl of oatmeal, whole-wheat crackers).', proof: 'Text Proof: Name the fiber source consumed.' },
                { id: 'dietary_sugar_free', name: 'üîé Check 1 Item for Hidden Sugar', value: 10, description: 'Increases dietary awareness and literacy.', instructions: 'Pick one packaged item from your pantry/fridge and read the ingredients list to identify if it contains added sugar.', proof: 'Text Proof: Name the food and state whether it contained added sugar.' },
                { id: 'dietary_healthy_link', name: 'üîó Find & Bookmark 1 Low-Budget Recipe', value: 25, description: 'Planning and research for long-term habits.', instructions: 'Find one healthy recipe online that costs $5 or less to prepare and save the link.', proof: 'Text Proof: Paste the link or recipe title.' },
                { id: 'dietary_spice_water', name: 'üçã Add Flavor to Water', value: 10, description: 'Making healthy hydration more appealing.', instructions: 'Add a slice of lemon, lime, or a sprig of mint/basil to your next glass of water.', proof: 'Text Proof: State the addition and the time consumed.' },
                { id: 'dietary_soup_small', name: 'ü•£ Make a Small Bowl of Veggie Broth', value: 30, description: 'Warm, low-calorie comfort food.', instructions: 'Quickly make a small bowl of simple, low-cost vegetable broth or soup (from cube/powder is fine).', proof: 'File Proof: A photo of the warm broth/soup.' },
                { id: 'dietary_slow_chew', name: 'üêå Chew Snack Slowly (5 min)', value: 20, description: 'Mindful eating practice.', instructions: 'Take a small, healthy snack (nut, cracker) and chew it slowly, taking 5 minutes to complete it.', proof: 'Text Proof: Describe the taste changes over the 5 minutes.' },
                { id: 'dietary_herbal_tea_3', name: 'üçµ Prepare & Drink 3 Different Herbal Teas', value: 15, description: 'Exploring non-impulsive alternatives.', instructions: 'Prepare and drink three different types of herbal tea today (can be small sips).', proof: 'Text Proof: List the three types of herbal tea consumed.' },
                { id: 'dietary_omega_snack', name: 'ü•ú Eat Omega-3 Rich Snack', value: 30, description: 'Providing good fats for brain function.', instructions: 'Eat a small handful of walnuts, almonds, or flaxseeds.', proof: 'Text Proof: Name the snack consumed and the quantity.' },
                { id: 'dietary_carb_swap', name: 'üåæ Swap One Simple Carb Snack', value: 20, description: 'Incremental improvement in food quality.', instructions: 'If you crave a simple carb snack (e.g., chips, white bread), swap it for a whole-grain or complex carb alternative.', proof: 'Text Proof: Name the simple carb avoided and the healthy swap made.' },
                { id: 'dietary_plan_breakfast', name: 'üç≥ Lay Out Healthy Breakfast Ingredients', value: 15, description: 'Setting up success for the next morning.', instructions: 'Lay out all non-perishable ingredients and utensils needed for a healthy breakfast tomorrow morning.', proof: 'File Proof: A photo of the laid-out breakfast items.' },
                { id: 'dietary_clean_fridge', name: 'üóëÔ∏è Throw Out Expired Food (10 min)', value: 25, description: 'Eliminating temptation and promoting fresh food storage.', instructions: 'Spend 10 minutes clearing out and throwing away any expired food from your refrigerator.', proof: 'Text Proof: Describe the amount of food you discarded.' },
                { id: 'dietary_vitamin_check', name: 'üíä Take Your Daily Vitamin', value: 10, description: 'Small act of self-care and nutritional consistency.', instructions: 'If applicable, take your daily vitamin or supplement.', proof: 'Text Proof: Name the vitamin/supplement taken.' },
                { id: 'dietary_salt_reduce', name: 'üßÇ Consciously Reduce Salt in Next Meal', value: 15, description: 'Promotes mindful seasoning and reduced sodium intake.', instructions: 'Prepare your next meal (or next snack) using half the salt you would normally use.', proof: 'Text Proof: Confirm the meal and the reduction in salt used.' },
                { id: 'dietary_fresh_herb', name: 'üåø Use a Fresh Herb in a Dish', value: 25, description: 'Enhancing flavor naturally and mindfully.', instructions: 'Purchase or use a fresh herb (e.g., mint, cilantro, parsley) in a dish prepared today.', proof: 'File Proof: A photo of the dish with the fresh herb visible.' },
                { id: 'dietary_hot_drink', name: '‚ô®Ô∏è Drink Small Cup of Decaf Coffee', value: 20, description: 'Satisfies routine craving without caffeine spike.', instructions: 'Prepare and slowly drink a small cup of decaffeinated coffee or coffee substitute.', proof: 'Text Proof: Describe the temperature and feeling of the drink.' },
                { id: 'dietary_review_intake', name: 'üìà Write Down Last 2 Hours of Intake', value: 15, description: 'Promotes honest assessment of recent food choices.', instructions: 'Write down every food and drink item consumed in the last two hours, including estimated portion sizes.', proof: 'Text Proof: List the last three items consumed.' },
                { id: 'dietary_apple_cider', name: 'üçé Drink Diluted Apple Cider Vinegar', value: 10, description: 'Small healthy ritual to reset digestion.', instructions: 'Drink one tablespoon of apple cider vinegar mixed with a glass of water.', proof: 'Text Proof: Confirm the completion and describe the taste.' },
                { id: 'dietary_yogurt_snack', name: 'üç¶ Eat Small Plain Yogurt Container', value: 20, description: 'Probiotic boost and healthy oral fixation.', instructions: 'Eat a small container of plain, unflavored yogurt.', proof: 'Text Proof: Confirm the type of yogurt and the time consumed.' },
            ],
            // 5. Strategic Fortification Tasks (Strategy) - Long-term, future-proofing
            'STRATEGY': [
                { id: 'strategy_clear_adult', name: 'üóëÔ∏è Clear All Adult-Themed Digital Content/Sites', value: 45, description: 'High-impact removal of core, long-term triggers.', instructions: 'Go through bookmarks, downloaded files, and browser history to purge any adult or explicit content sources.', proof: 'Text Proof: State the digital locations cleared (e.g., "Bookmarks and download folder").' },
                { id: 'strategy_avoid_discussion', name: 'üó£Ô∏è Plan Avoidance of Triggering Discussions', value: 35, description: 'Prepares a defense against social triggers.', instructions: 'Write down a clear, single-sentence phrase you can use immediately to exit or redirect a conversation that discusses triggering content.', proof: 'Text Proof: Paste the exact phrase you wrote down.' },
                { id: 'strategy_pre_commit_time', name: '‚è≥ Pre-Commit 1 Hour to Deep Work', value: 30, description: 'Creating structure to prevent idleness.', instructions: 'Select a block of time (at least 60 minutes) later today and commit to working on a single important task.', proof: 'Text Proof: State the time and the task committed to.' },
                { id: 'strategy_move_furniture', name: 'üõãÔ∏è Re-Arrange 1 Piece of Furniture', value: 40, description: 'Changes the environment to disrupt routine-based triggers.', instructions: 'Physically move one piece of furniture in your main impulse zone to subtly change the visual environment.', proof: 'Text Proof: Name the item moved and its new location.' },
                { id: 'strategy_trigger_plan', name: 'üìù Write "If-Then" Plan for Next Urge', value: 25, description: 'Pre-commits a healthy response to a future trigger.', instructions: 'Write down: "IF I feel [Trigger], THEN I will immediately do [Positive Action]." Post it visibly.', proof: 'Text Proof: Paste the complete "If-Then" statement.' },
                { id: 'strategy_no_phone_bed', name: 'üõèÔ∏è Move Phone Away From Bed', value: 20, description: 'Removes the overnight impulse trigger.', instructions: 'Move your phone charger to a completely different room to prevent browsing upon waking or before sleep.', proof: 'File Proof: A photo showing the phone charger relocated.' },
                { id: 'strategy_hide_wallet', name: 'üí≥ Hide Wallet/Card', value: 30, description: 'Removes easy access to financial impulse triggers.', instructions: 'Physically put your wallet or primary spending card out of immediate reach (e.g., locked drawer, upstairs closet).', proof: 'Text Proof: State the hidden location of the card/wallet.' },
                { id: 'strategy_setup_notification', name: 'üîî Mute 5 Non-Essential Notifications', value: 25, description: 'Reduces digital interruptions and external pressure.', instructions: 'Go into your phone settings and mute notifications from five specific apps that are not essential.', proof: 'File Proof: Screenshot of your muted notification settings.' },
                { id: 'strategy_create_distraction_kit', name: 'üõ†Ô∏è Assemble a "Distraction Kit"', value: 35, description: 'Creates a dedicated resource for fighting immediate urges.', instructions: 'Gather 3-5 non-digital items (e.g., book, journal, stress ball, puzzle) into a physical box/bag near your main workspace.', proof: 'File Proof: Photo of the assembled kit.' },
                { id: 'strategy_define_win', name: 'üèÜ Define "Win" for Tomorrow', value: 15, description: 'Clarity on next day‚Äôs immediate goal.', instructions: 'Write down one small, measurable action that would count as a "win" for you tomorrow.', proof: 'Text Proof: State the single "win" defined for tomorrow.' },
                { id: 'strategy_schedule_break', name: 'üìÖ Schedule Mandatory Break', value: 20, description: 'Commit to proactive self-care.', instructions: 'Immediately schedule a 30-minute break later today that is protected from interruption and is focused on relaxation (e.g., reading, stretching).', proof: 'Text Proof: State the time and activity scheduled.' },
                { id: 'strategy_write_1_barrier', name: 'üìù Write Down 1 Strongest Barrier', value: 10, description: 'Analyzes the most effective defense strategy.', instructions: 'Identify and write down the single most difficult obstacle you face when trying to give in to the impulse.', proof: 'Text Proof: State the barrier identified.' },
                { id: 'strategy_buy_healthy', name: 'üõí Buy 3 Healthy Snacks', value: 20, description: 'Pre-loading the environment with healthy alternatives.', instructions: 'Purchase three inexpensive, non-impulsive healthy snacks to have ready at home (e.g., oats, bananas, eggs).', proof: 'File Proof: Photo of the three purchased items.' },
                { id: 'strategy_social_mute', name: 'üîá Mute One Social Connection', value: 15, description: 'Reduces passive emotional triggers from others.', instructions: 'Mute (not block) one social media account or group chat that tends to trigger jealousy, comparison, or frustration.', proof: 'Text Proof: State the account/group that was muted.' },
                { id: 'strategy_email_unsubscribe', name: 'üìß Unsubscribe from 5 Marketing Emails', value: 15, description: 'Reduces commercial triggers in the inbox.', instructions: 'Unsubscribe from five marketing lists that encourage impulse buying or consumption.', proof: 'Text Proof: State the number of unsubscribes completed.' },
                { id: 'strategy_set_accountability', name: 'ü§ù Set Accountability Check-in', value: 30, description: 'Creates external barrier through social commitment.', instructions: 'Ask a trusted friend or mentor to check in with you at a specific time tomorrow about your impulse log entry.', proof: 'Text Proof: Name the person contacted and the check-in time.' },
                { id: 'strategy_update_os', name: 'üíª Update Operating System/Apps', value: 10, description: 'Ensures system stability, prevents using "lag" or "need to update" as an excuse.', instructions: 'Check for and complete one minor non-critical operating system or app update.', proof: 'Text Proof: Name the app or OS updated.' },
                { id: 'strategy_prepare_tomorrow', name: 'üìù Prepare Outfit/Items for Tomorrow', value: 15, description: 'Reduces decision fatigue for next day, minimizing early morning impulse.', instructions: 'Lay out the full outfit and necessary items (keys, lunch) you need for tomorrow.', proof: 'File Proof: Photo of the prepared items.' },
                { id: 'strategy_delete_bookmarks', name: '‚≠ê Delete 5 Impulsive Bookmarks', value: 15, description: 'Clears easy digital access to triggers.', instructions: 'Delete five stored browser bookmarks that lead directly to impulsive websites/stores.', proof: 'Text Proof: State the types of sites removed (e.g., "3 shopping sites, 2 news feeds").' },
                { id: 'strategy_write_replacement', name: 'üìÑ Write Down 3 "Replacement" Activities', value: 20, description: 'Creates immediate, positive alternatives list for sudden urges.', instructions: 'Write and post a list of three healthy activities you genuinely enjoy to replace the impulse when it strikes.', proof: 'Text Proof: List the three replacement activities.' },
                { id: 'strategy_delete_games', name: 'üéÆ Delete 1 Impulsive Game/Entertainment App', value: 45, description: 'High-friction removal of a time-consuming digital trigger.', instructions: 'Delete a single video game or entertainment app that often leads to prolonged, impulsive use.', proof: 'Text Proof: State the name of the item deleted.' },
                { id: 'strategy_clear_cookies', name: 'üç™ Clear Cookies/Cache on Main Browser', value: 10, description: 'Forces re-login on tempting sites, increasing friction.', instructions: 'Clear all cookies, site data, and cache on your most-used web browser.', proof: 'Text Proof: Confirm the browser and action completed.' },
                { id: 'strategy_lock_money_app', name: 'üîê Add Lock to Money App', value: 30, description: 'Adds security friction against impulse spending.', instructions: 'Set up a password, PIN, or biometric lock on any financial or shopping app.', proof: 'Text Proof: Name the app and the type of lock applied.' },
                { id: 'strategy_setup_distraction_plan', name: 'üìù Write Down 5 Minute Distraction Plan', value: 20, description: 'A detailed plan of non-digital actions for immediate use.', instructions: 'Write a sequence of three small, non-digital actions to perform when the next small urge appears.', proof: 'Text Proof: List the sequence of three actions.' },
                { id: 'strategy_change_password', name: 'üîë Change 1 Password to a Hard One', value: 15, description: 'Creates a mental barrier before accessing a highly tempting account.', instructions: 'Change the password for one non-essential but tempting online account to a very long, complex password.', proof: 'Text Proof: State the site and confirm the complexity (e.g., "used 15+ characters").' },
            ],
            // 6. Protection Tasks (Immediate Counter) - NEW CATEGORY
            'PROTECTION': [
                 { id: 'protection_screen_lock', name: 'üõë Set 15-Min Screen Blackout', value: 35, description: 'Immediate lockdown to cut the digital spiral at its source.', instructions: 'Use your phone\'s native digital well-being features (Focus Mode, Downtime, etc.) to enforce a 15-minute total app blackout.', proof: 'File Proof: Screenshot of the countdown timer showing 15 minutes set.' },
                 { id: 'protection_journal_urge', name: '‚úçÔ∏è Journal for 2 Minutes: The Urge', value: 25, description: 'Interrupts the impulse with forced rational, disciplined writing.', instructions: 'Write down EXACTLY what you want to do and why, non-stop, for two minutes, until the initial wave passes.', proof: 'Text Proof: Paste the first three sentences of your writing.' },
                 { id: 'protection_device_move', name: '‚û°Ô∏è Move Device 1 Room Away', value: 30, description: 'Creates a physical barrier to increase friction for the next 5 minutes.', instructions: 'Take your phone/laptop/controller to another room, close the door, and return to your current location (without the device).', proof: 'Text Proof: Name the room the device was moved to.' },
                 { id: 'protection_leave_room', name: 'üö∂ Immediately Leave This Place', value: 40, description: 'High-impact physical disengagement from a triggering environment.', instructions: 'Stand up and walk immediately to a different room, or step outside for 2 minutes, forcing a context switch.', proof: 'Text Proof: Name the new location you moved to.' },
                 { id: 'protection_cold_water', name: 'üßä Splash Face With Cold Water', value: 15, description: 'Uses temperature shock to reset the nervous system (physiological interruption).', instructions: 'Go to the sink and splash cold water on your face/neck three times.', proof: 'Text Proof: Describe the physical shock and your current alertness level.' },
                 { id: 'protection_count_breath', name: 'üßò Count 10 Deep, Slow Breaths', value: 20, description: 'Fast mental reset using physiological control to regulate heart rate.', instructions: 'Count your breath in and out (10 times) while sitting upright. Focus only on the numbers and air movement.', proof: 'Text Proof: Confirm the completion and state how your focus feels.' },
                 { id: 'protection_block_reels', name: 'üö´ Mute/Block Reels/Short Videos for 5 Min', value: 35, description: 'Immediate friction against endless consumption of short-form media.', instructions: 'Use the mute or hide functions in the social media app/site, or simply turn off audio/visual content for 5 minutes.', proof: 'File Proof: Screenshot of the app showing the feed *without* sound/video for 5 minutes.' },
                 { id: 'protection_contact_friend', name: 'ü§ù Text 1 Friend About a Neutral Topic', value: 25, description: 'Immediate social connection to break isolation and inward focus.', instructions: 'Send a text to one person about a neutral topic (weather, a movie, work) and wait for a reply.', proof: 'Text Proof: State the friend\'s initial and the topic of the message.' },
                 { id: 'protection_affirmation', name: 'üó£Ô∏è Say 3 Affirmations Aloud 5 Times', value: 10, description: 'Resets negative self-talk using a simple verbal repetition ritual.', instructions: 'Choose three positive phrases (e.g., "I am safe," "I can wait") and repeat each one aloud 5 times.', proof: 'Text Proof: List the three affirmations used.' },
                 { id: 'protection_look_away', name: 'üëÅÔ∏è Focus on 5 Non-Screen Objects', value: 15, description: 'Breaks the visual focus on the trigger by practicing grounding.', instructions: 'Without turning your head, slowly name and describe five non-screen objects in your periphery.', proof: 'Text Proof: List the five objects observed.' },
                 { id: 'protection_listen_5_min', name: 'üéß Listen to Instrumental Music for 5 Minutes', value: 20, description: 'Uses non-verbal, structured sound to displace impulsive thought.', instructions: 'Put on a piece of music without lyrics or intense beat and focus solely on the sound for 5 minutes.', proof: 'Text Proof: Name the piece of music/artist.' },
                 { id: 'protection_stretch_1_min', name: 'ü§∏ Perform a 1-Minute Deep Stretch', value: 15, description: 'Uses mild physical discomfort/focus to interrupt mental state.', instructions: 'Do a simple, deep stretch (like a toe-touch or shoulder stretch) and hold the position for 60 seconds.', proof: 'Text Proof: Name the stretch performed.' },
                 { id: 'protection_write_consequences', name: 'üìù Write Down 3 Negative Consequences', value: 20, description: 'Forces immediate confrontation with the destructive outcome of giving in.', instructions: 'On a piece of paper, write down the three most painful results of engaging with the impulse.', proof: 'Text Proof: State the topic of the consequences (e.g., "Shame, exhaustion, wasted money").' },
                 { id: 'protection_clean_desk_1min', name: 'üßπ Clear 1 Square Foot of Desk Space', value: 10, description: 'Micro-dose of productive activity to restart the momentum.', instructions: 'Clear one small, highly visible patch of clutter on your main work surface.', proof: 'File Proof: A photo of the cleared space.' },
                 { id: 'protection_change_activity', name: 'üîÑ Switch Activity for 5 Minutes', value: 30, description: 'A rapid context switch to disrupt the habit chain.', instructions: 'Stop whatever you are doing and immediately pick up a simple, pre-planned alternative task (like coloring, tidying, or checking mail) for 5 minutes.', proof: 'Text Proof: Name the alternative task performed.' },
                 { id: 'protection_pet_5_min', name: 'üêï Pet/Cuddle an Animal for 5 Minutes', value: 20, description: 'Uses touch and focus on another living being to ground oneself.', instructions: 'Spend 5 minutes mindfully petting your dog, cat, or other pet.', proof: 'Text Proof: Name the pet and describe its texture.' },
                 { id: 'protection_hot_drink', name: '‚òï Make a Quick Hot Drink (5 min ritual)', value: 25, description: 'Mindful ritual focused on warmth and preparation to delay action.', instructions: 'Make a hot drink (tea, cocoa, coffee) and focus only on the preparation steps and temperature.', proof: 'Text Proof: Name the drink prepared.' },
                 { id: 'protection_cold_object', name: 'ü•∂ Hold Ice or Cold Object (1 min)', value: 15, description: 'Intense sensory input to distract from emotional distress.', instructions: 'Hold a piece of ice or a cold aluminum can/glass in your hand for one full minute.', proof: 'Text Proof: Describe the sensation of the cold object.' },
                 { id: 'protection_read_book_5', name: 'üìñ Read 5 Pages of a Physical Book', value: 20, description: 'Forces sustained, non-digital attention span.', instructions: 'Read five pages from any non-digital, physical book or magazine.', proof: 'Text Proof: State the title and page numbers read.' },
                 { id: 'protection_chew_gum', name: 'üç¨ Chew Strong Mint Gum (2 min)', value: 10, description: 'Oral fixation replacement with strong sensory distraction.', instructions: 'Chew a piece of strongly flavored mint gum or suck on a hard candy for 2 minutes.', proof: 'Text Proof: Describe the flavor and its intensity.' },
                 { id: 'protection_schedule_work', name: 'üóìÔ∏è Schedule the Difficult Task (2 min)', value: 25, description: 'Confronts procrastination immediately by committing to a future time.', instructions: 'Open your calendar and schedule a 30-minute block to work on the task you were avoiding.', proof: 'Text Proof: Name the task and the scheduled time.' },
                 { id: 'protection_walk_phone', name: 'üö∂ Walk 30 Steps Without Looking at Phone', value: 15, description: 'Short physical interruption to break the phone habit loop.', instructions: 'Take your phone/device and walk 30 steps while holding it, but without looking at the screen.', proof: 'Text Proof: Confirm the completion of the 30 steps.' },
                 { id: 'protection_check_lights', name: 'üí° Turn on All Lights in Room', value: 10, description: 'Changes environmental context and increases alertness.', instructions: 'Turn on all available light sources in your current room (including lamps/overhead lights).', proof: 'Text Proof: Confirm the change in lighting.' },
                 { id: 'protection_digital_break', name: 'üìµ Log Off/Sign Out of 1 Tempting Account', value: 30, description: 'Adds friction to accessing a highly habitual digital trigger.', instructions: 'Sign completely out (log out) of your most tempting social media or entertainment account.', proof: 'Text Proof: Name the account logged out of.' },
                 { id: 'protection_small_errand', name: '‚úâÔ∏è Check Mailbox/Run Quick Errand', value: 15, description: 'Forces a brief change of physical location and focus.', instructions: 'Perform a single, non-digital, necessary small task that requires moving locations (e.g., checking the mail, taking out trash).', proof: 'Text Proof: Name the quick task completed.' },
            ],
        };
        // Combine all quests into a single array for length check and fallback
        const ALL_QUESTS = Object.values(ALL_QUEST_CATEGORIES).flat();
        
        // --- Configuration: Monster Progression (Expanded to 20 triggers) ---
        const MONSTER_PROGRESSION = {
            'IMPULSE': [ 
                { stage: 1, name: 'Lesser Urge Wisp', tasks_multiplier: 1.0, emoji: 'üêõ', skills: [{ name: 'Distraction Strike (Weak)', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Persistent Habit Wraith', tasks_multiplier: 1.25, emoji: 'üëª', skills: [{ name: 'Distraction Strike', damage: 15, effect: 'Lower Focus' }, { name: 'Doubt Whisper', damage: 8, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Shadow of Relapse (Elite)', tasks_multiplier: 1.5, emoji: 'üëπ', skills: [{ name: 'Focus Drain', damage: 15, effect: 'Lower Focus' }, { name: 'Overwhelming Rush', damage: 25, effect: 'None' }] },
            ],
            'BOREDOM': [
                { stage: 1, name: 'Idleness Slime', tasks_multiplier: 1.0, emoji: 'üêå', skills: [{ name: 'Procrastination Goo', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Time-Sink Vortex', tasks_multiplier: 1.25, emoji: 'üåÄ', skills: [{ name: 'Mental Fog', damage: 15, effect: 'Lower Focus' }, { name: 'Energy Drain', damage: 10, effect: 'None' }] },
                { stage: 3, name: 'The Void of Routine', tasks_multiplier: 1.5, emoji: '‚ö´', skills: [{ name: 'Existential Dread', damage: 15, effect: 'Lower Willpower' }, { name: 'Overwhelming Rush', damage: 25, effect: 'None' }] },
            ],
            'STRESS': [
                { stage: 1, name: 'Anxiety Flicker', tasks_multiplier: 1.0, emoji: '‚ö°', skills: [{ name: 'Worry Spike', damage: 12, effect: 'None' }] },
                { stage: 2, name: 'Panic Cloud', tasks_multiplier: 1.25, emoji: '‚õàÔ∏è', skills: [{ name: 'Worry Spike (Strong)', damage: 18, effect: 'None' }, { name: 'Overthinking Static', damage: 5, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Burnout Hydra', tasks_multiplier: 1.5, emoji: 'üî•', skills: [{ name: 'Total Overload', damage: 20, effect: 'Lower Focus' }, { name: 'Emotional Collapse', damage: 15, effect: 'Lower Willpower' }] },
            ],
            'ISOLATION': [
                { stage: 1, name: 'Lonely Echo', tasks_multiplier: 1.0, emoji: 'üë§', skills: [{ name: 'Silent Whisper', damage: 5, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Distrust Barrier', tasks_multiplier: 1.25, emoji: 'üß±', skills: [{ name: 'Silent Whisper (Strong)', damage: 10, effect: 'Lower Willpower' }, { name: 'Self-Doubt Pulse', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Shadow of Withdrawal', tasks_multiplier: 1.5, emoji: 'üï∑Ô∏è', skills: [{ name: 'Total Isolation', damage: 20, effect: 'Lower Willpower' }, { name: 'Existential Dread', damage: 15, effect: 'Lower Focus' }] },
            ],
            // 5. FATIGUE
            'FATIGUE': [
                { stage: 1, name: 'Energy Slump', tasks_multiplier: 1.1, emoji: 'üò¥', skills: [{ name: 'Heavy Limbs', damage: 5, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Drowsiness Fog', tasks_multiplier: 1.3, emoji: 'üí§', skills: [{ name: 'Snooze Button', damage: 10, effect: 'Lower Focus' }, { name: 'Exhaustion Wave', damage: 12, effect: 'None' }] },
                { stage: 3, name: 'Deep Slumber Coil', tasks_multiplier: 1.6, emoji: 'üõå', skills: [{ name: 'Apathy Cloud', damage: 15, effect: 'Lower Willpower' }, { name: 'Zero Motivation', damage: 20, effect: 'Lower Focus' }] },
            ],
            // 6. ANGER
            'ANGER': [
                { stage: 1, name: 'Frustration Spark', tasks_multiplier: 1.0, emoji: 'üí¢', skills: [{ name: 'Heat Flash', damage: 10, effect: 'None' }] },
                { stage: 2, name: 'Rage Burst', tasks_multiplier: 1.3, emoji: 'üî•', skills: [{ name: 'Lashing Out', damage: 15, effect: 'Lower Willpower' }, { name: 'Resentment Strike', damage: 10, effect: 'None' }] },
                { stage: 3, name: 'Fury Tempest', tasks_multiplier: 1.5, emoji: 'üåã', skills: [{ name: 'Destructive Impulse', damage: 20, effect: 'Lower Focus' }, { name: 'Vengeful Strike', damage: 25, effect: 'Lower Willpower' }] },
            ],
            // 7. GUILT
            'GUILT': [
                { stage: 1, name: 'Shame Whisper', tasks_multiplier: 1.2, emoji: 'üòî', skills: [{ name: 'Self-Criticism', damage: 8, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Remorse Shadow', tasks_multiplier: 1.4, emoji: 'üé≠', skills: [{ name: 'Hollow Feeling', damage: 12, effect: 'None' }, { name: 'Isolation Pull', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Self-Loathing Spectre', tasks_multiplier: 1.7, emoji: 'üíî', skills: [{ name: 'Regret Drain', damage: 18, effect: 'Lower Willpower' }, { name: 'Hopelessness Wave', damage: 22, effect: 'None' }] },
            ],
            // 8. CELEBRATION
            'CELEBRATION': [
                { stage: 1, name: 'Reward Surge', tasks_multiplier: 1.0, emoji: 'ü•≥', skills: [{ name: 'False Complacency', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Entitlement Flare', tasks_multiplier: 1.2, emoji: 'üëë', skills: [{ name: 'I Deserve This', damage: 15, effect: 'None' }, { name: 'Overconfidence Haze', damage: 5, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Just One Time Fiend', tasks_multiplier: 1.4, emoji: 'üèÜ', skills: [{ name: 'Justification Strike', damage: 18, effect: 'Lower Focus' }, { name: 'Momentary Lapse', damage: 20, effect: 'None' }] },
            ],
            // 9. FINANCIAL
            'FINANCIAL': [
                { stage: 1, name: 'Budget Worry', tasks_multiplier: 1.1, emoji: 'üí∏', skills: [{ name: 'Scarcity Fear', damage: 8, effect: 'None' }] },
                { stage: 2, name: 'Impulse Buyer Blob', tasks_multiplier: 1.3, emoji: 'üõí', skills: [{ name: 'Retail Therapy Pull', damage: 12, effect: 'Lower Willpower' }, { name: 'Debt Anxiety', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Financial Ruin Spectre', tasks_multiplier: 1.6, emoji: 'üìâ', skills: [{ name: 'Panic Buy Surge', damage: 20, effect: 'Lower Focus' }, { name: 'Overspending Rush', damage: 25, effect: 'None' }] },
            ],
            // 10. PAIN
            'PAIN': [
                { stage: 1, name: 'Ache Nuisance', tasks_multiplier: 1.2, emoji: 'ü©π', skills: [{ name: 'Distraction Seek', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Chronic Flare', tasks_multiplier: 1.4, emoji: 'ü§ï', skills: [{ name: 'Discomfort Wave', damage: 15, effect: 'None' }, { name: 'Self-Pity Indulgence', damage: 8, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Suffering Leviathan', tasks_multiplier: 1.6, emoji: 'ü§¢', skills: [{ name: 'Escape Mechanism', damage: 22, effect: 'Lower Focus' }, { name: 'Emotional Overload', damage: 18, effect: 'Lower Willpower' }] },
            ],
            // 11. HUNGER
            'HUNGER': [
                { stage: 1, name: 'Empty Stomach Grumble', tasks_multiplier: 1.0, emoji: 'üçî', skills: [{ name: 'Low Sugar Fog', damage: 5, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Hanger Monster', tasks_multiplier: 1.2, emoji: 'üò†', skills: [{ name: 'Cravings Surge', damage: 10, effect: 'Lower Willpower' }, { name: 'Irrationality Pulse', damage: 12, effect: 'None' }] },
                { stage: 3, name: 'Blood Sugar Crash King', tasks_multiplier: 1.4, emoji: 'üòµ', skills: [{ name: 'Immediate Relief Demand', damage: 20, effect: 'Lower Focus' }, { name: 'Binge Frenzy', damage: 25, effect: 'None' }] },
            ],
            // 12. TIME_CRUNCH
            'TIME_CRUNCH': [
                { stage: 1, name: 'Deadline Pressure', tasks_multiplier: 1.1, emoji: '‚è∞', skills: [{ name: 'Hasty Action', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Rushing Cascade', tasks_multiplier: 1.3, emoji: '‚è±Ô∏è', skills: [{ name: 'Lost Control', damage: 15, effect: 'None' }, { name: 'Short-Cut Temptation', damage: 10, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Panic Inducer', tasks_multiplier: 1.5, emoji: 'üí•', skills: [{ name: 'Total Freeze', damage: 20, effect: 'Lower Focus' }, { name: 'Breakdown Wave', damage: 25, effect: 'None' }] },
            ],
            // 13. FAILURE
            'FAILURE': [
                { stage: 1, name: 'Setback Sting', tasks_multiplier: 1.2, emoji: 'üìâ', skills: [{ name: 'Failure Label', damage: 10, effect: 'Lower Willpower' }] },
                { stage: 2, name: 'Disappointment Barrier', tasks_multiplier: 1.4, emoji: 'üöß', skills: [{ name: 'Give Up Whisper', damage: 15, effect: 'Lower Focus' }, { name: 'Worthlessness Pulse', damage: 8, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Spiral of Defeat', tasks_multiplier: 1.6, emoji: 'üå™Ô∏è', skills: [{ name: 'Catastrophic Thinking', damage: 22, effect: 'Lower Focus' }, { name: 'Emotional Retreat', damage: 18, effect: 'None' }] },
            ],
            // 14. ENVIRONMENT
            'ENVIRONMENT': [
                { stage: 1, name: 'Clutter Chaos', tasks_multiplier: 1.0, emoji: 'üóëÔ∏è', skills: [{ name: 'Overwhelm Fog', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Noise Disturbance', tasks_multiplier: 1.2, emoji: 'üîä', skills: [{ name: 'Irritation Spike', damage: 15, effect: 'None' }, { name: 'Sensory Overload', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Unclean Abyss', tasks_multiplier: 1.4, emoji: 'üï≥Ô∏è', skills: [{ name: 'Avoidance Pull', damage: 20, effect: 'Lower Willpower' }, { name: 'Malaise Aura', damage: 15, effect: 'None' }] },
            ],
            // 15. TECHNOLOGY
            'TECHNOLOGY': [
                { stage: 1, name: 'Screen Glare', tasks_multiplier: 1.1, emoji: 'üì±', skills: [{ name: 'Dopamine Hook', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Notification Siren', tasks_multiplier: 1.3, emoji: 'üîî', skills: [{ name: 'Endless Scroll', damage: 12, effect: 'Lower Willpower' }, { name: 'FOMO Attack', damage: 10, effect: 'None' }] },
                { stage: 3, name: 'Digital Addiction Beast', tasks_multiplier: 1.5, emoji: 'üëæ', skills: [{ name: 'Time Warp', damage: 20, effect: 'Lower Focus' }, { name: 'Blue Light Curse', damage: 25, effect: 'None' }] },
            ],
            // 16. RELATIONSHIP
            'RELATIONSHIP': [
                { stage: 1, name: 'Conflict Vex', tasks_multiplier: 1.2, emoji: 'üó£Ô∏è', skills: [{ name: 'Miscommunication', damage: 10, effect: 'None' }] },
                { stage: 2, name: 'Misunderstanding Knot', tasks_multiplier: 1.4, emoji: 'üîó', skills: [{ name: 'Argument Spiral', damage: 15, effect: 'Lower Willpower' }, { name: 'Distrust Field', damage: 10, effect: 'Lower Focus' }] },
                { stage: 3, name: 'Relationship Rift', tasks_multiplier: 1.6, emoji: 'üíî', skills: [{ name: 'Isolation Pull', damage: 22, effect: 'Lower Willpower' }, { name: 'Emotional Stonewall', damage: 18, effect: 'None' }] },
            ],
            // 17. NOVELTY
            'NOVELTY': [
                { stage: 1, name: 'Shiny Object Lure', tasks_multiplier: 1.0, emoji: '‚ú®', skills: [{ name: 'Distraction Dart', damage: 8, effect: 'Lower Focus' }] },
                { stage: 2, name: 'New Idea Frenzy', tasks_multiplier: 1.2, emoji: 'üí°', skills: [{ name: 'Commitment Phobia', damage: 12, effect: 'Lower Willpower' }, { name: 'Shallow Dive', damage: 10, effect: 'None' }] },
                { stage: 3, name: 'Eternal Searcher', tasks_multiplier: 1.4, emoji: 'üî≠', skills: [{ name: 'Abandon Project', damage: 18, effect: 'Lower Willpower' }, { name: 'Unfocused Hyperactivity', damage: 20, effect: 'Lower Focus' }] },
            ],
            // 18. FEAR
            'FEAR': [
                { stage: 1, name: 'Worry Seed', tasks_multiplier: 1.3, emoji: 'üòü', skills: [{ name: 'What-If Question', damage: 5, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Future Doubt', tasks_multiplier: 1.5, emoji: 'üîÆ', skills: [{ name: 'Catastrophize', damage: 15, effect: 'None' }, { name: 'Avoidance Maneuver', damage: 10, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Paralyzing Dread', tasks_multiplier: 1.7, emoji: 'ü•∂', skills: [{ name: 'Escape Urge', damage: 22, effect: 'Lower Focus' }, { name: 'Panic Attack', damage: 25, effect: 'None' }] },
            ],
            // 19. HABIT
            'HABIT': [
                { stage: 1, name: 'Routine Pull', tasks_multiplier: 1.0, emoji: 'üîÅ', skills: [{ name: 'Automatic Action', damage: 8, effect: 'None' }] },
                { stage: 2, name: 'Trigger Chain', tasks_multiplier: 1.2, emoji: '‚õìÔ∏è', skills: [{ name: 'Muscle Memory', damage: 12, effect: 'Lower Willpower' }, { name: 'Mindless Repetition', damage: 15, effect: 'None' }] },
                { stage: 3, name: 'Old Pathway Demon', tasks_multiplier: 1.4, emoji: 'üòà', skills: [{ name: 'Resign to Fate', damage: 20, effect: 'Lower Focus' }, { name: 'Behavioral Cascade', damage: 25, effect: 'None' }] },
            ],
            // 20. AVOIDANCE
            'AVOIDANCE': [
                { stage: 1, name: 'Procrastination Sloth', tasks_multiplier: 1.1, emoji: 'ü¶•', skills: [{ name: 'Distraction Search', damage: 10, effect: 'Lower Focus' }] },
                { stage: 2, name: 'Difficult Task Wall', tasks_multiplier: 1.3, emoji: 'üß±', skills: [{ name: 'Overwhelm', damage: 15, effect: 'None' }, { name: 'Delay & Deny', damage: 10, effect: 'Lower Willpower' }] },
                { stage: 3, name: 'Fear of Effort Titan', tasks_multiplier: 1.5, emoji: 'üõë', skills: [{ name: 'Escape Route Find', damage: 22, effect: 'Lower Focus' }, { name: 'Task Paralysis', damage: 18, effect: 'None' }] },
            ],
        };


        // --- Research-Based Player Skills (Renamed to Heroic Names) ---
        const ALL_PLAYER_SKILLS = [
            { id: 'thought_record', name: 'Mind Cleave', cost: 250, unlocked: false, 
              desc: 'üí° Identify and challenge a core distorted thought. Uses **Focus**. **Attack Bonus +20%**, cures DEBUFFS.', 
              type: 'Attack', powerCost: 100 }, 
            { id: 'mindfulness_shield', name: 'Clarity Aegis', cost: 400, unlocked: false, 
              desc: 'üßò Focus on the present. Uses **Focus**. **Defense Boost +50%** for next Monster turn.', 
              type: 'Defend', powerCost: 150 },
            { id: 'delay_gratification', name: 'Temporal Stasis', cost: 500, unlocked: false, 
              desc: '‚è≥ Stall the Urge. Uses **Willpower**. **Heals +10 HP** and delays Monster turn by 1.', 
              type: 'Heal', powerCost: 200 },
            { id: 'support_call', name: 'Vanguard Rally', cost: 750, unlocked: false, 
              desc: 'ü§ù Use social accountability. Uses **Willpower**. **Heals +30 HP** and deals minor damage (10).', 
              type: 'Heal', powerCost: 300 }
        ];

        const XP_TO_LEVEL_UP = 1000;

        // --- UPDATED INITIAL STATE (FIXED BASE STATS) ---
        const INITIAL_STATE = {
            phase: 'creation', 
            // Character Stats - Using fixed base values
            charName: 'Sentinel', // Default Alias
            charRealName: '', 
            charCity: '', 
            charSource: '', 
            charPhone: '', 
            charLevel: 1,
            charHP: 120, // Fixed Base HP
            charXP: 0,
            charWillpower: 5, // Fixed Base Stat (Affects Attack/Heal Power)
            charFocus: 5,     // Fixed Base Stat (Affects Defense/Mental Skills)
            charMotivation: 5, // Fixed Base Stat
            charDefense: 5,    // Fixed Base Stat
            charSpecial: 'None', 
            charPurpose: 'Master the Impulse.', 
            charAge: 0, 
            charGender: '', // NEW: Default gender

            // Battle State (Simplified for multi-battle support)
            activeLogId: null, // ID of the battle the user is currently focused on
            
            dashboardView: 'log', 
            unlockedSkills: [], // Array of unlocked skill IDs
        };

        let gameState = { ...INITIAL_STATE };
        let PLAYER_SKILLS = []; // Initialized by loadSkills()

        // --- DOM Elements (Declared globally for event handlers) ---
        const splashScreen = document.getElementById('splash-screen');
        const charCreationSection = document.getElementById('character-creation-section');
        const characterForm = document.getElementById('character-form');
        const triggerForm = document.getElementById('trigger-form');
        const triggerSpecificInput = document.getElementById('trigger-specific'); 
        const triggerSection = document.getElementById('trigger-section');
        
        // Navigation Elements
        const dashboardNav = document.getElementById('dashboard-nav');
        const navLogBtn = document.getElementById('nav-log');
        const navBattleBtn = document.getElementById('nav-battle');
        const navSkillsBtn = document.getElementById('nav-skills'); // NEW REF
        const navGuideBtn = document.getElementById('nav-guide'); 
        const navProfileBtn = document.getElementById('nav-profile'); // Updated from nav-settings
        const logViewContainer = document.getElementById('log-view-container'); 
        const battleQuestContainer = document.getElementById('battle-quest-container'); 
        const skillsViewContainer = document.getElementById('skills-view-container'); 
        const guideViewContainer = document.getElementById('guide-view-container'); 
        const profileViewContainer = document.getElementById('profile-view-container'); // Updated from settings-view-container
        
        // Battle View Specific Elements
        const battleLogList = document.getElementById('battle-log-list'); 
        const monsterListContainer = document.getElementById('monster-list'); 
        const monsterHistoryContainer = document.getElementById('monster-history-container'); // CORRECTED REF ID
        const activeBattleView = document.getElementById('active-battle-view'); 
        const activeBattleTitle = document.getElementById('active-battle-title'); 
        
        const monsterDisplay = document.getElementById('monster-display');
        const tasksList = document.getElementById('tasks-list');
        const powerBar = document.getElementById('power-bar');
        const powerText = document.getElementById('power-text');
        const weaponText = document.getElementById('weapon-text');
        const attackButton = document.getElementById('attack-button');
        const launchBattleButton = document.getElementById('launch-battle-button'); 
        const attackStatusMessage = document.getElementById('attack-status-message'); 
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const resetButton = document.getElementById('reset-button');
        const avatarContainer = document.getElementById('avatar-container');
        const statsPanel = document.getElementById('stats-panel');
        // New DOM reference for the dashboard card itself for toggling visibility
        const dashboardDisplay = document.getElementById('dashboard-display');
        
        // General Modal Elements
        const generalModal = document.getElementById('general-modal');
        const generalModalTitle = document.getElementById('general-modal-title');
        const generalModalMessage = document.getElementById('general-modal-message');
        
        // New Stats Modal Elements (for simplified UI update)
        const statsModal = document.getElementById('stats-modal');
        const fullStatsContent = document.getElementById('full-stats-content');
        
        // IDs for the individual stat fields within the modal's static HTML
        const statLevel = document.getElementById('stat-level');
        const statHP = document.getElementById('stat-hp');
        const statWillpower = document.getElementById('stat-willpower');
        const statFocus = document.getElementById('stat-focus');
        const statDefense = document.getElementById('stat-defense');
        const statMotivation = document.getElementById('stat-motivation');


        // Battle Arena Elements
        const battleArenaModal = document.getElementById('battle-arena-modal');
        const arenaLog = document.getElementById('arena-log');
        const arenaMonsterEmoji = document.getElementById('arena-monster-emoji');
        const arenaMonsterName = document.getElementById('arena-monster-name');
        const arenaMonsterHpBar = document.getElementById('arena-monster-hp-bar');
        const arenaMonsterHpText = document.getElementById('arena-monster-hp-text');
        const arenaPlayerEmoji = document.getElementById('arena-player-emoji');
        const arenaPlayerName = document.getElementById('arena-player-name');
        const arenaPlayerHpBar = document.getElementById('arena-player-hp-bar');
        const arenaPlayerHpText = document.getElementById('arena-player-hp-text');
        const arenaAttackBtn = document.getElementById('arena-attack-btn');
        const arenaMessage = document.getElementById('arena-message');

        // Log Form Elements
        const logDateInput = document.getElementById('log-date');
        const actionTakenGroup = document.getElementById('action-taken-group');
        const gaveInFields = document.getElementById('gave-in-fields');
        const logAfterFeelings = document.getElementById('log-after-feelings');
        const logTriedInstead = document.getElementById('log-tried-instead');
        const resistedFields = document.getElementById('resisted-fields');
        const logHistoryContainer = document.getElementById('log-history'); 
        
        // Log Filter Elements
        const dateStartFilter = document.getElementById('date-start-filter');
        const dateEndFilter = document.getElementById('date-end-filter');
        const logFilterSection = document.getElementById('log-filter-section'); 
        const logFormContainer = document.getElementById('log-form-container'); 


        // Proof Modal Elements
        const proofModal = document.getElementById('proof-modal');
        const proofForm = document.getElementById('proof-form');
        const proofTaskName = document.getElementById('proof-task-name');
        const proofPowerReward = document.getElementById('proof-power-reward'); 
        const proofTaskIdInput = document.getElementById('proof-task-id');
        const proofFileInput = document.getElementById('proof-file');
        const proofTextarea = document.getElementById('proof-text');
        const proofPreview = document.getElementById('proof-preview'); 
        const proofTypeSelect = document.getElementById('proof-type-select');
        const fileProofContainer = document.getElementById('file-proof-container');
        const textProofContainer = document.getElementById('text-proof-container');
        
        // Profile Form Elements (formerly Settings)
        const settingsForm = document.getElementById('settings-form');
        const settingsRealNameInput = document.getElementById('settings-real-name'); 
        const settingsCityInput = document.getElementById('settings-city'); 
        const settingsSourceInput = document.getElementById('settings-source'); 
        const settingsPhoneInput = document.getElementById('settings-phone'); 
        const settingsAgeInput = document.getElementById('settings-age'); 
        const settingsGenderInput = document.getElementById('settings-gender'); // NEW REF
        const editProfileBtn = document.getElementById('edit-profile-btn'); 
        const settingsSaveBtn = document.getElementById('settings-save-btn'); 
        const settingsCancelBtn = document.getElementById('settings-cancel-btn'); 


        // --- Persistence & Storage Functions ---
        
        function loadSkills() {
             try {
                const stored = localStorage.getItem(SKILLS_KEY);
                const unlockedIds = stored ? JSON.parse(stored) : [];
                
                // Initialize PLAYER_SKILLS array with full definitions
                PLAYER_SKILLS = ALL_PLAYER_SKILLS.map(skill => ({
                    ...skill,
                    unlocked: unlockedIds.includes(skill.id)
                }));
            } catch (error) {
                console.error("Error loading skills from localStorage:", error);
                PLAYER_SKILLS = ALL_PLAYER_SKILLS;
            }
        }

        function saveSkills() {
            try {
                localStorage.setItem(SKILLS_KEY, JSON.stringify(PLAYER_SKILLS.filter(s => s.unlocked).map(s => s.id)));
            } catch (error) {
                console.error("Error saving skills to localStorage:", error);
            }
        }

        function unlockSkill(skillId) {
            const skill = PLAYER_SKILLS.find(s => s.id === skillId);
            if (skill && !skill.unlocked) {
                skill.unlocked = true;
                saveSkills();
                updateUI();
                return true;
            }
            return false;
        }

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error("Error loading progress from localStorage:", error);
                return {};
            }
        }

        function saveProgress(progress) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
            } catch (error) {
                console.error("Error saving progress to localStorage:", error);
            }
        }

        function loadCharacter() {
            try {
                const stored = localStorage.getItem(CHARACTER_KEY);
                // Ensure default values for new fields when loading old data
                const char = stored ? JSON.parse(stored) : null;
                if (char) {
                    char.charName = char.charName || 'Sentinel'; // Default back to Sentinel if alias was removed
                    char.charRealName = char.charRealName || '';
                    char.charCity = char.charCity || '';
                    char.charSource = char.charSource || '';
                    char.charPhone = char.charPhone || ''; 
                    char.charAge = char.charAge || 0; 
                    char.charGender = char.charGender || ''; // NEW: Handle gender loading
                    // Set fixed defaults if old data is missing them or was based on sliders (which are now gone)
                    char.charHP = char.charHP || INITIAL_STATE.charHP;
                    char.charWillpower = char.charWillpower || INITIAL_STATE.charWillpower;
                    char.charFocus = char.charFocus || INITIAL_STATE.charFocus;
                    char.charMotivation = char.charMotivation || INITIAL_STATE.charMotivation;
                    char.charDefense = char.charDefense || INITIAL_STATE.charDefense;
                    char.charSpecial = char.charSpecial || INITIAL_STATE.charSpecial;
                    char.charPurpose = char.charPurpose || INITIAL_STATE.charPurpose;
                }
                return char;
            } catch (error) {
                console.error("Error loading character from localStorage:", error);
                return null;
            }
        }

        function saveCharacter(characterData) {
            try {
                localStorage.setItem(CHARACTER_KEY, JSON.stringify(characterData));
            } catch (error) {
                console.error("Error saving character to localStorage:", error);
            }
            // Log character data when saved/updated
            logDataToSheet(characterData, 'Profile');
        }

        function loadLogs() {
            try {
                const stored = localStorage.getItem(LOG_HISTORY_KEY);
                // Ensure every log has a unique ID for battle tracking
                const logs = stored ? JSON.parse(stored) : [];
                return logs.map(log => ({ 
                    ...log, 
                    id: log.id || crypto.randomUUID(),
                    // Ensure monsterCurrentHP exists on old logs, defaulting to maxHealth
                    monsterCurrentHP: log.monsterCurrentHP || log.monsterHealth || 0 
                }));
            } catch (error) {
                console.error("Error loading logs from localStorage:", error);
                return [];
            }
        }

        function saveLog(logEntry) {
            try {
                const logs = loadLogs();
                // Find existing log entry by ID and replace it, or unshift the new one
                const existingIndex = logs.findIndex(log => log.id === logEntry.id);
                if (existingIndex !== -1) {
                    logs[existingIndex] = logEntry;
                } else {
                    logs.unshift(logEntry); // Add new log to the beginning (most recent first)
                }
                
                // CRITICAL FIX: The error is here. Large media files (proofDataURL) saved previously exceeded the quota.
                // We must remove the dataURL property before saving to prevent future quota errors.
                // We ensure the temporary proofDataURL is removed but type/text is kept.
                const logsToSave = logs.map(log => ({
                    ...log,
                    tasks: log.tasks ? log.tasks.map(task => ({ // Check if tasks property exists
                        ...task,
                        // Ensure large data URL is not persisted, but icon metadata is safe
                        proofDataURL: undefined 
                    })) : [], // If no tasks, save empty array
                }));

                localStorage.setItem(LOG_HISTORY_KEY, JSON.stringify(logsToSave));

                // Log the full log entry to the Google Sheet (LogSheet)
                logDataToSheet(logEntry, 'Logs');

                return logs;
            } catch (error) {
                console.error("Error saving log to localStorage:", error);
                // Return the logs we tried to save to maintain in-memory state, even if persistence failed
                return logs;
            }
        }
        
        function getLogById(id) {
             const logs = loadLogs();
             return logs.find(log => log.id === id);
        }

        /** Helper function to get the checked radio button value by name */
        function getRadioValue(name) {
            const radio = document.querySelector(`input[name="${name}"]:checked`);
            return radio ? radio.value : '';
        }

        /** * Implements the custom logic to calculate the character's base stats 
         * based on the simplified profile inputs.
         */
        function calculateBaseStats(formData) {
            const { 
                realName, city, source, phone, age, gender // Added gender
            } = formData;
            
            // --- Base Stat Initialization (FIXED) ---
            let calculatedWillpower = INITIAL_STATE.charWillpower;
            let calculatedFocus = INITIAL_STATE.charFocus;
            let calculatedHP = INITIAL_STATE.charHP;
            let calculatedDefense = INITIAL_STATE.charDefense; 
            let calculatedMotivation = INITIAL_STATE.charMotivation; 
            
            // Character name comes from the user input (char-real-name)
            const calculatedName = realName.split(' ')[0] || 'Sentinel';
            
            const calculatedSpecial = INITIAL_STATE.charSpecial;
            const calculatedPurpose = INITIAL_STATE.charPurpose;
            
            return {
                charName: calculatedName, // Set name from user input
                charRealName: realName, 
                charCity: city, 
                charSource: source, 
                charPhone: phone, 
                charAge: age, 
                charGender: gender, // Added gender
                charLevel: 1,
                charHP: calculatedHP, 
                charXP: 0, 
                charWillpower: calculatedWillpower,
                charFocus: calculatedFocus,
                charMotivation: calculatedMotivation,
                charDefense: calculatedDefense,
                charSpecial: calculatedSpecial,
                charPurpose: calculatedPurpose,
            };
        }


        // --- Monster Progression Logic ---
        
        /**
         * Categorizes the impulse based on user input text.
         */
        function getTriggerType(triggerText) {
            const lowerText = triggerText.toLowerCase();
            
            // Priority Check for 20 Triggers (Must be defined in MONSTER_PROGRESSION)
            if (lowerText.includes('stress') || lowerText.includes('pressure') || lowerText.includes('overwhelmed')) return { type: 'STRESS', emoji: MONSTER_PROGRESSION.STRESS[0].emoji };
            if (lowerText.includes('bored') || lowerText.includes('nothing to do') || lowerText.includes('idle')) return { type: 'BOREDOM', emoji: MONSTER_PROGRESSION.BOREDOM[0].emoji };
            if (lowerText.includes('lonely') || lowerText.includes('alone') || lowerText.includes('isolation')) return { type: 'ISOLATION', emoji: MONSTER_PROGRESSION.ISOLATION[0].emoji };
            if (lowerText.includes('tired') || lowerText.includes('low energy') || lowerText.includes('sleepy') || lowerText.includes('fatigue')) return { type: 'FATIGUE', emoji: MONSTER_PROGRESSION.FATIGUE[0].emoji };
            if (lowerText.includes('angry') || lowerText.includes('frustrated') || lowerText.includes('resentment') || lowerText.includes('fury')) return { type: 'ANGER', emoji: MONSTER_PROGRESSION.ANGER[0].emoji };
            if (lowerText.includes('shame') || lowerText.includes('guilty') || lowerText.includes('self-criticism') || lowerText.includes('remorse')) return { type: 'GUILT', emoji: MONSTER_PROGRESSION.GUILT[0].emoji };
            if (lowerText.includes('success') || lowerText.includes('reward') || lowerText.includes('celebration') || lowerText.includes('won')) return { type: 'CELEBRATION', emoji: MONSTER_PROGRESSION.CELEBRATION[0].emoji };
            if (lowerText.includes('money') || lowerText.includes('financial') || lowerText.includes('spending') || lowerText.includes('debt')) return { type: 'FINANCIAL', emoji: MONSTER_PROGRESSION.FINANCIAL[0].emoji };
            if (lowerText.includes('pain') || lowerText.includes('ache') || lowerText.includes('discomfort') || lowerText.includes('injury')) return { type: 'PAIN', emoji: MONSTER_PROGRESSION.PAIN[0].emoji };
            if (lowerText.includes('hungry') || lowerText.includes('crave') || lowerText.includes('low sugar') || lowerText.includes('hanger')) return { type: 'HUNGER', emoji: MONSTER_PROGRESSION.HUNGER[0].emoji };
            if (lowerText.includes('deadline') || lowerText.includes('rushing') || lowerText.includes('time crunch') || lowerText.includes('late')) return { type: 'TIME_CRUNCH', emoji: MONSTER_PROGRESSION.TIME_CRUNCH[0].emoji };
            if (lowerText.includes('fail') || lowerText.includes('mistake') || lowerText.includes('setback') || lowerText.includes('disappointment')) return { type: 'FAILURE', emoji: MONSTER_PROGRESSION.FAILURE[0].emoji };
            if (lowerText.includes('clutter') || lowerText.includes('mess') || lowerText.includes('noise') || lowerText.includes('unclean')) return { type: 'ENVIRONMENT', emoji: MONSTER_PROGRESSION.ENVIRONMENT[0].emoji };
            if (lowerText.includes('screen') || lowerText.includes('phone') || lowerText.includes('notification') || lowerText.includes('digital') || lowerText.includes('scrolling')) return { type: 'TECHNOLOGY', emoji: MONSTER_PROGRESSION.TECHNOLOGY[0].emoji };
            if (lowerText.includes('conflict') || lowerText.includes('argument') || lowerText.includes('misunderstanding') || lowerText.includes('relationship')) return { type: 'RELATIONSHIP', emoji: MONSTER_PROGRESSION.RELATIONSHIP[0].emoji };
            if (lowerText.includes('new idea') || lowerText.includes('shiny') || lowerText.includes('unfocused') || lowerText.includes('distraction')) return { type: 'NOVELTY', emoji: MONSTER_PROGRESSION.NOVELTY[0].emoji };
            if (lowerText.includes('worry') || lowerText.includes('fear') || lowerText.includes('doubt') || lowerText.includes('future')) return { type: 'FEAR', emoji: MONSTER_PROGRESSION.FEAR[0].emoji };
            if (lowerText.includes('automatic') || lowerText.includes('habit') || lowerText.includes('routine') || lowerText.includes('old path')) return { type: 'HABIT', emoji: MONSTER_PROGRESSION.HABIT[0].emoji };
            if (lowerText.includes('procrastinat') || lowerText.includes('avoid') || lowerText.includes('difficult task') || lowerText.includes('delay')) return { type: 'AVOIDANCE', emoji: MONSTER_PROGRESSION.AVOIDANCE[0].emoji };

            // Default to generic IMPULSE
            return { type: 'IMPULSE', emoji: MONSTER_PROGRESSION.IMPULSE[0].emoji };
        }
        
        /**
         * Calculates monster stats dynamically based on player stats for difficulty scaling.
         */
        function calculateMonsterStats(stage, tasksMultiplier, playerHP, playerWillpower, playerFocus) {
            
            const basePlayerStat = (playerWillpower + playerFocus) / 2;
            const healthDifficultyFactor = [1.0, 1.25, 1.5]; // Multiplier for HP across stages
            const damageDifficultyFactor = [1.0, 1.3, 1.6];  // Multiplier for Damage across stages
            
            let baseHealth = (basePlayerStat * 8) + (playerHP * 0.2); 
            
            // Add randomness and apply stage multiplier
            let monsterHealth = Math.round(
                baseHealth * healthDifficultyFactor[stage - 1] * (0.9 + Math.random() * 0.2) // +/- 10% randomness
            );
            
            // Ensure a minimum base health for starting stages.
            const minMonsterHealth = (stage === 1) ? 80 : 110;
            
            // Ensure monster is not ridiculously easy or impossible
            monsterHealth = Math.max(monsterHealth, minMonsterHealth);
            
            // Upper cap to prevent insanity (Monster HP should not exceed player's HP by much for stage 1)
            monsterHealth = Math.min(monsterHealth, playerHP * 1.5);

            // Base damage calculation: Target effective damage is around 15% of player max HP per hit.
            const targetDamagePerHit = playerHP * 0.15; 
            
            let monsterBaseDamage = Math.round(
                targetDamagePerHit * damageDifficultyFactor[stage - 1] * (0.8 + Math.random() * 0.4) // +/- 20% randomness
            );

            // Ensure base damage isn't zero
            monsterBaseDamage = Math.max(10, monsterBaseDamage); 


            return {
                health: monsterHealth,
                damageFactor: 1.0, 
                baseDamage: monsterBaseDamage,
            };
        }


        function getMonsterByCount(triggerType, winCount) {
            // Use the determined triggerType to look up the progression
            const progression = MONSTER_PROGRESSION[triggerType];
            
            let stageIndex = 0;
            if (winCount >= 1 && winCount <= 2) {
                stageIndex = 1;
            } else if (winCount >= 3) {
                stageIndex = 2;
            }

            const monsterConfig = progression[Math.min(stageIndex, progression.length - 1)];
            
            const monsterEmoji = monsterConfig.emoji;

            const calculatedStats = calculateMonsterStats(
                stageIndex + 1, 
                monsterConfig.tasks_multiplier, 
                gameState.charHP, 
                gameState.charWillpower, 
                gameState.charFocus
            );

            // Calculate skill-specific damage based on the dynamically scaled base damage
            const scaledSkills = monsterConfig.skills.map(skill => {
                 let skillMultiplier = 1.0;
                 if (skill.name.includes('(Weak)')) skillMultiplier = 0.8;
                 else if (skill.name.includes('(Strong)')) skillMultiplier = 1.2;
                 
                 // If the skill is purely an effect (damage=0 in config), keep it at 0
                 const finalDamage = skill.damage === 0 ? 0 : Math.round(calculatedStats.baseDamage * skillMultiplier);

                 return {
                     ...skill,
                     damage: Math.max(0, finalDamage)
                 };
            });


            return { 
                ...monsterConfig, 
                isElite: winCount >= 3,
                // Use dynamically calculated health
                health: calculatedStats.health, 
                stage: stageIndex + 1,
                // NEW: Use the updated emoji
                monsterEmoji: monsterEmoji,
                tasks_multiplier: monsterConfig.tasks_multiplier, 
                skills: scaledSkills,
            };
        }
        
        /**
         * Selects a balanced mix of tasks (Physical, Mental, Emotional, Dietary, STRATEGY, PROTECTION)
         * to generate a new list of quests for the monster.
         */
        function calculateTasksForMonster(monsterHealth, triggerType, tasksMultiplier = 1.0) {
            
            const targetPower = monsterHealth; 
            const requiredPowerWithMultiplier = Math.ceil(targetPower * tasksMultiplier);
            
            let assignedQuests = [];
            let currentPower = 0;
            
            // --- 6 Categories ---
            const categories = ['PHYSICAL', 'EMOTIONAL', 'MENTAL', 'DIETARY', 'STRATEGY', 'PROTECTION']; 
            const defaultQuota = 2; 
            const categoryQuota = {};
            categories.forEach(cat => categoryQuota[cat] = defaultQuota);
            
            // --- Relevance Weighting ---
            const relevantAdjustment = 2; // Increase quota by this much
            const lessRelevantReduction = 1; // Decrease quota by this much

            switch (triggerType) {
                case 'TECHNOLOGY':
                case 'BOREDOM':
                case 'AVOIDANCE':
                    // High focus on immediate counter (Protection) and environment change (Strategy)
                    categoryQuota['PROTECTION'] = Math.min(4, defaultQuota + relevantAdjustment);
                    categoryQuota['STRATEGY'] = Math.min(4, defaultQuota + relevantAdjustment);
                    categoryQuota['DIETARY'] = Math.max(1, defaultQuota - lessRelevantReduction);
                    categoryQuota['PHYSICAL'] = Math.max(1, defaultQuota - lessRelevantReduction);
                    break;
                case 'STRESS':
                case 'ANGER':
                case 'FEAR':
                    // High focus on emotional regulation and mental reframing
                    categoryQuota['EMOTIONAL'] = Math.min(4, defaultQuota + relevantAdjustment);
                    categoryQuota['MENTAL'] = Math.min(4, defaultQuota + relevantAdjustment);
                    categoryQuota['DIETARY'] = Math.max(1, defaultQuota - lessRelevantReduction);
                    categoryQuota['PROTECTION'] = Math.max(1, defaultQuota - lessRelevantReduction);
                    break;
                case 'GUILT':
                case 'ISOLATION':
                case 'RELATIONSHIP':
                    // High focus on emotional connection and mental self-compassion
                    categoryQuota['EMOTIONAL'] = Math.min(4, defaultQuota + relevantAdjustment);
                    categoryQuota['MENTAL'] = Math.min(3, defaultQuota + 1);
                    categoryQuota['PROTECTION'] = Math.min(3, defaultQuota + 1); // Immediate boundary setting
                    categoryQuota['PHYSICAL'] = Math.max(1, defaultQuota - lessRelevantReduction);
                    break;
                // Default uses 2 for all 6 categories (total 12 tasks max)
            }


            // 1. Assign tasks based on calculated quotas
            for (const category of categories) {
                 const targetTasks = categoryQuota[category] || defaultQuota;
                
                 let shuffledCategoryQuests = [...ALL_QUEST_CATEGORIES[category]].sort(() => 0.5 - Math.random());
                 
                 for (let i = 0; i < Math.min(targetTasks, shuffledCategoryQuests.length); i++) {
                     const quest = shuffledCategoryQuests[i];
                     if (!assignedQuests.some(q => q.id === quest.id)) { // Check for duplicates
                         assignedQuests.push(quest);
                         currentPower += quest.value;
                     }
                 }
            }
            
            // 2. Fallback: If total power is still low, add more random tasks until target power is met or max tasks reached (12)
            let safetyIndex = 0;
            const shuffledRemainingQuests = [...ALL_QUESTS].sort(() => 0.5 - Math.random());

            while (currentPower < requiredPowerWithMultiplier && assignedQuests.length < 12 && safetyIndex < shuffledRemainingQuests.length) {
                const quest = shuffledRemainingQuests[safetyIndex];
                if (!assignedQuests.some(q => q.id === quest.id)) {
                    assignedQuests.push(quest);
                    currentPower += quest.value;
                }
                safetyIndex++;
            }

            // Map to the log format
            return assignedQuests.map(q => ({ ...q, completed: false }));
        }


        // --- General Utility Functions ---

        function closeGeneralModal() { generalModal.classList.add('hidden'); }
        
        function closeProofModal() { 
            proofModal.classList.add('hidden'); 
            // Reset the dynamic fields when closing
            proofTypeSelect.value = "";
            handleProofTypeChange(""); // Correctly reset dynamic visibility and required fields
        }

        // Updated resetGame to use localStorage.clear()
        function resetGame() { 
            localStorage.clear();
            // Log data reset to the sheet
            logDataToSheet({ charName: gameState.charName, reason: 'Game Reset' }, 'Admin');
            window.location.reload(); 
        }

        function handleProofTypeChange(type) {
            fileProofContainer.classList.add('hidden');
            textProofContainer.classList.add('hidden');
            proofFileInput.value = '';
            proofTextarea.value = '';
            
            // Reset proof preview text
            proofPreview.innerHTML = type === 'file' ? 'Upload your file...' : 'Select a proof file (image, video, voice) or enter text...';


            // Toggle visibility and required status
            if (type === 'file') {
                fileProofContainer.classList.remove('hidden');
                proofFileInput.setAttribute('required', 'required');
                proofTextarea.removeAttribute('required');
            } else if (type === 'text') {
                textProofContainer.classList.remove('hidden');
                proofTextarea.setAttribute('required', 'required');
                proofFileInput.removeAttribute('required');
            } else {
                proofFileInput.removeAttribute('required');
                proofTextarea.removeAttribute('required');
            }
        }


        // NEW: Show Message Function (Modal or Box)
        function showGeneralModal(title, message) {
            generalModalTitle.textContent = title;
            generalModalMessage.innerHTML = message;
            generalModal.classList.remove('hidden');
        }
        // NEW: Show Message Function (Modal or Box)

/**
 * Shows a standard text-only modal. (Original function, now reset helper)
 */
function showGeneralModal(title, message) {
    // Reset from video settings if they were applied
    const modalDiv = document.getElementById('general-modal').querySelector('div');
    modalDiv.classList.remove('max-w-2xl', 'bg-slate-900');
    modalDiv.classList.add('max-w-sm', 'bg-slate-700'); 
    generalModalTitle.textContent = title;
    generalModalMessage.innerHTML = message;
    generalModal.classList.remove('hidden');
}


// ‚û°Ô∏è 2. ADD THE PROFESSIONAL VIDEO MODAL FUNCTION HERE
/**
 * Shows a custom modal with the YouTube video embedded for onboarding.
 */
function showGuideVideoModal(title, message, videoId) {
    const modalDiv = document.getElementById('general-modal').querySelector('div');
    
    // 1. Temporarily widen the modal container and change background for video
    modalDiv.classList.remove('max-w-sm', 'bg-slate-700');
    modalDiv.classList.add('max-w-2xl', 'bg-slate-900'); 

    // 2. Create the YouTube iframe embed HTML
    const videoEmbed = `
        <div class="relative w-full overflow-hidden mb-4" style="padding-top: 56.25%"> 
            <iframe
                // ‚û°Ô∏è FIX: Use the dynamic variable ${videoId} for the source
                src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                allowfullscreen
                class="absolute top-0 left-0 w-full h-full rounded-lg"
                referrerpolicy="strict-origin-when-cross-origin"
            ></iframe>
        </div>
    `;

    generalModalTitle.textContent = title;
    generalModalMessage.innerHTML = message + videoEmbed;
    generalModal.classList.remove('hidden');
}


// 3. Keep the MODIFIED closeGeneralModal (Next step below)
function closeGeneralModal() { 
    // Reset modal width and background when closing
    const modalDiv = document.getElementById('general-modal').querySelector('div');
    modalDiv.classList.remove('max-w-2xl', 'bg-slate-900');
    modalDiv.classList.add('max-w-sm', 'bg-slate-700'); // Restore original background

    document.getElementById('general-modal').classList.add('hidden'); 
    
    // CRITICAL: Stop the video playback and clear the embed
    generalModalMessage.innerHTML = '';
}

        function showMessage(text, type) {
            messageBox.classList.remove('hidden', 'bg-blue-600', 'bg-success', 'bg-danger', 'bg-yellow-600');
            messageText.innerHTML = text;
            resetButton.classList.add('hidden');

            switch (type) {
                case 'info':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-blue-600';
                    break;
                case 'success':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-success';
                    break;
                case 'danger':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-danger';
                    break;
                case 'win':
                    messageBox.className = 'p-4 rounded-xl text-center shadow-lg transition duration-300 bg-yellow-600';
                    resetButton.classList.remove('hidden');
                    break;
            }
        }
        
        // --- Character Creation UI Logic (MINIMAL) ---

        // Only need a single step validation function
        function validateSingleStepForm() {
            const form = document.getElementById('character-form');
            let isValid = true;
            
            const inputs = Array.from(form.querySelectorAll('input[required], select[required], textarea[required]'));
            inputs.forEach(input => {
                // Specific validation for phone number
                if (input.id === 'char-phone' && !/^\d*$/.test(input.value)) {
                    input.setCustomValidity('Phone number must contain only digits.');
                } else if (input.id === 'char-phone') {
                    input.setCustomValidity(''); // Clear custom error if valid
                }

                if (!input.value.trim() || !input.checkValidity()) {
                    isValid = false;
                }
            });
            
            return isValid;
        }


        // --- Dashboard & Rendering Logic ---
        
        /**
         * NEW: Opens the modal containing all detailed character stats.
         * FIX: Explicitly targets the correct element IDs within the modal structure.
         */
        function openStatsModal() {
            const char = gameState;
            
            // Populate the modal content fields using the global DOM references
            statLevel.textContent = char.charLevel;
            statHP.textContent = char.charHP;
            // Show current debuff status in the stats modal
            const willpowerStatus = battleArenaState.playerWillpowerModifier !== 0 ? ` (${battleArenaState.playerWillpowerModifier > 0 ? '+' : ''}${battleArenaState.playerWillpowerModifier})` : '';
            const focusStatus = battleArenaState.playerFocusModifier !== 0 ? ` (${battleArenaState.playerFocusModifier > 0 ? '+' : ''}${battleArenaState.playerFocusModifier})` : '';

            statWillpower.textContent = `${char.charWillpower} / 10${willpowerStatus}`;
            statFocus.textContent = `${char.charFocus} / 10${focusStatus}`;
            statDefense.textContent = char.charDefense;
            statMotivation.textContent = `${char.charMotivation} / 10`;
            
            // The HTML structure already exists statically in the modal, so we just update the content.
            
            statsModal.classList.remove('hidden');
        }


        function changeDashboardView(view) {
            gameState.dashboardView = view;
            // CRITICAL FIX: Explicitly set activeLogId to null when switching to non-battle views
            if (view !== 'battle' && view !== 'active-battle') { 
                gameState.activeLogId = null;
            }
            updateUI();
        }

        function renderDashboard() {
            renderCharacterStats();
            setLogDateToToday();
            setupLogActionListeners();
        }
        
        /**
         * NEW: Toggles the visibility of the Impulse Log Form.
         */
        function toggleLogForm() {
             logFormContainer.classList.toggle('active');
             // Added check for 'active' class to determine if it should be hidden
             logFormContainer.classList.toggle('hidden', !logFormContainer.classList.contains('active'));
             
             // If filter is open, close it for clarity
             if (logFilterSection.classList.contains('active')) {
                toggleLogFilter();
             }
        }
        
        /**
         * NEW: Toggles the visibility of the Date Filter section.
         */
        function toggleLogFilter() {
            logFilterSection.classList.toggle('hidden');
            logFilterSection.classList.toggle('active', !logFilterSection.classList.contains('hidden'));

            // If log form is open, close it for clarity
            if (logFormContainer.classList.contains('active')) {
                toggleLogForm();
            }
        }

        // Expose toggles globally for button clicks
        window.toggleLogForm = toggleLogForm;
        window.toggleLogFilter = toggleLogFilter;

        // NEW FEATURE: Level Up Check
        function checkLevelUp() {
            if (gameState.charXP >= XP_TO_LEVEL_UP) {
                gameState.charLevel++;
                gameState.charXP -= XP_TO_LEVEL_UP; // Remaining XP carries over

                // Permanent Stat Boosts
                gameState.charHP += 10;
                gameState.charWillpower = Math.min(10, gameState.charWillpower + 1);
                gameState.charFocus = Math.min(10, gameState.charFocus + 1);
                gameState.charDefense = Math.min(15, gameState.charDefense + 1);

                saveCharacter(gameState);
                
                showGeneralModal('‚ú® LEVEL UP!', 
                    `You reached **Sentinel Level ${gameState.charLevel}**!
                    <br><br>
                    **Permanent Gains:**
                    <ul>
                        <li>+10 Max HP</li>
                        <li>+1 Willpower (Attack Stat)</li>
                        <li>+1 Focus (Skill/Defense Stat)</li>
                        <li>+1 Defense</li>
                    </ul>
                    The next level target is **${XP_TO_LEVEL_UP} XP**.`);
                
                // Log level up event
                logDataToSheet({ charName: gameState.charName, newLevel: gameState.charLevel }, 'LevelUps');

                // Re-check in case user gained enough XP to skip multiple levels
                if (gameState.charXP >= XP_TO_LEVEL_UP) {
                    checkLevelUp();
                }
            }
        }

        /**
         * Renders the MINIMAL character stats (Avatar, Level, XP Bar) for the main dashboard card.
         */
        function renderCharacterStats() {
            const char = gameState;
            let currentWeapon = 'Wooden Club ü™µ';
            let currentArmor = 'Rags';
            let aura = 'gray-500';

            // Simple visual progression based on XP/Level
            if (char.charLevel >= 3) {
                currentWeapon = 'Radiant Blade ‚ú®';
                currentArmor = 'Full Plate';
                aura = 'yellow-400';
            } else if (char.charLevel >= 2) {
                currentWeapon = 'Iron Sword ‚öîÔ∏è';
                currentArmor = 'Steel Armor';
                aura = 'blue-500';
            }

            // Avatar Container (Minimal)
            avatarContainer.innerHTML = `
                <p class="text-5xl mb-1">${char.charSpecial === 'Inner Light' ? '‚ú®' : ''} ü•∑</p>
                <p class="text-sm font-bold text-${aura} text-shadow">Level ${char.charLevel}</p>
            `;

            // Stats Panel (Minimal: Name + XP Bar Only)
            statsPanel.innerHTML = `
                <h4 class="text-lg font-bold text-text-light mb-1">${char.charName}</h4>
                <p class="text-xs font-semibold text-secondary">XP Progress: ${char.charXP} / ${XP_TO_LEVEL_UP} XP</p>
                <div class="progress-bar-container h-2">
                    <div class="progress-bar bg-success" style="width: ${Math.min(100, (char.charXP / XP_TO_LEVEL_UP) * 100)}%;"></div>
                </div>
            `;
        }
        
        function renderLogHistory(filteredLogs = null) {
            const logs = filteredLogs || loadLogs();
            if (logs.length === 0) {
                logHistoryContainer.innerHTML = '<p class="text-slate-400 text-sm">No impulse logs recorded yet.</p>';
                return;
            }

            logHistoryContainer.innerHTML = logs.map(log => {
                const statusClass = log.status === 'Defeated' ? 'border-success' : log.status === 'Lost' ? 'border-danger' : log.status === 'Active' ? 'border-secondary' : 'border-slate-500';
                const statusEmoji = log.status === 'Defeated' ? '‚úÖ' : log.status === 'Lost' ? '‚ùå' : '‚öîÔ∏è';
                
                // Use log's specific emoji
                const monsterCard = log.monsterName ? 
                    `<span class="font-semibold text-text-light">${log.monsterEmoji} ${log.monsterName} (Stage ${log.monsterStage})</span>` :
                    `<span class="font-semibold text-text-light">No Monster Spawned</span>`;

                const completedTasks = log.tasks.filter(t => t.completed);
                const taskDetails = completedTasks.map(t => {
                    let proofIcon = 'üìù';
                    
                    // CRITICAL FIX: Use large icons for visual confirmation of proof type.
                    if (t.proofType === 'image') {
                        proofIcon = 'üñºÔ∏è';
                    } else if (t.proofType === 'video') {
                        proofIcon = 'üé¨';
                    } else if (t.proofType === 'audio') {
                        proofIcon = 'üé§';
                    }
                    
                    const proofText = t.proofText ? `<p class="text-xs text-slate-300 italic">"${t.proofText.substring(0, 50)}..."</p>` : '';

                    return `
                        <div class="flex items-center text-xs text-success/80 bg-slate-700/50 p-2 rounded-lg">
                            <span class="proof-icon mr-2">${proofIcon}</span>
                            <div>
                                <p class="font-medium">${t.name}</p>
                                ${proofText}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="log-entry ${statusClass} bg-slate-700/50">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="text-slate-400">${log.logDate}</span>
                            <span class="font-bold ${log.status === 'Defeated' ? 'text-success' : log.status === 'Lost' ? 'text-danger' : 'text-secondary'}">${statusEmoji} ${log.status}</span>
                        </div>
                        <p class="text-text-light mb-2 text-body">Impulse: ${log.triggerSpecific}</p>
                        
                        ${log.monsterName ? `<p class="text-sm mb-2">${monsterCard}</p>` : ''}

                        <div class="mt-3 border-t border-slate-600 pt-3">
                            <p class="font-semibold text-slate-300">Outcome: <span class="font-normal text-text-light">${log.actionTaken === 'Resisted' ? 'Won' : log.actionTaken === 'Delayed' ? 'Stalled' : 'Gave In'}</span></p>
                            ${log.actionTaken !== 'Gave In' && completedTasks.length > 0 ? 
                                `<p class="font-semibold text-slate-300 mt-2">üí™ Quests Completed:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-1">${taskDetails}</div>` : 
                                log.actionTaken === 'Gave In' ? `<p class="text-danger mt-2">Aftermath: ${log.afterFeelings}</p>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // NEW FEATURE: Date Filter Logic
        function filterLogHistory() {
            const startDate = dateStartFilter.value;
            const endDate = dateEndFilter.value;
            const allLogs = loadLogs();
            
            let filteredLogs = allLogs;
            
            if (startDate) {
                const start = new Date(startDate);
                filteredLogs = filteredLogs.filter(log => new Date(log.logDate) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                // Filter up to the end of the selected day
                end.setDate(end.getDate() + 1); 
                filteredLogs = filteredLogs.filter(log => new Date(log.logDate) < end);
            }
            
            renderLogHistory(filteredLogs);
        }

        function resetLogFilter() {
             dateStartFilter.value = '';
             dateEndFilter.value = '';
             filterLogHistory(); // Renders all logs
        }


        function renderMonsterHistory() {
            // Filter out 'Active' logs, as they are now displayed separately
            const allLogs = loadLogs().filter(log => log.status !== 'Active'); 
            
            const pastEncounters = allLogs.filter(log => log.status === 'Defeated' || log.status === 'Lost');

            if (pastEncounters.length === 0) {
                monsterHistoryContainer.innerHTML = '<p class="text-slate-400 text-sm">No completed or lost encounters recorded yet.</p>';
                return;
            }

            monsterHistoryContainer.innerHTML = pastEncounters.map(log => {
                let statusClass = 'border-slate-500';
                let statusText = 'Logged';
                
                if (log.status === 'Defeated') {
                    statusClass = 'border-success';
                    statusText = '‚úÖ DEFEATED';
                } else if (log.status === 'Lost') {
                    statusClass = 'border-danger';
                    statusText = '‚ùå LOST BATTLE';
                }

                return `
                    <div class="app-card p-4 flex justify-between items-center transition duration-200 bg-slate-700/50 no-hover">
                        <div class="space-y-1">
                            <h4 class="text-lg font-bold text-text-light">${log.monsterEmoji} ${log.monsterName} (Stage ${log.monsterStage})</h4>
                            <p class="text-xs text-slate-400 text-body">Impulse: ${log.triggerSpecific.substring(0, 30)}... | Logged: ${log.logDate}</p>
                            <p class="text-sm font-semibold ${log.status === 'Defeated' ? 'text-success' : 'text-danger'}">${statusText}</p>
                        </div>
                        <div class="text-right">
                             <p class="text-xs text-slate-400">Power: ${log.currentPower}/${log.monsterHealth}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderBattleLogList() {
            // Filter only Active encounters for the list view
            const activeLogs = loadLogs().filter(log => log.status === 'Active');
            
            if (activeLogs.length === 0) {
                monsterListContainer.innerHTML = '<p class="text-slate-400 text-sm">No active impulse threats. Log an impulse to begin an encounter!</p>';
                return;
            }

            monsterListContainer.innerHTML = activeLogs.map(log => {
                const monster = log.monsterName;
                const power = log.currentPower;
                const required = log.monsterHealth;
                const currentHP = log.monsterCurrentHP; // Get current HP for visual damage
                
                // Ensure currentHP is not greater than max health
                const healthPct = Math.min(100, (currentHP / required) * 100); 
                const powerPct = Math.min(100, (power / required) * 100); 

                return `
                    <div class="app-card p-4 flex justify-between items-center battle-card transition duration-200 cursor-pointer ${gameState.activeLogId === log.id ? 'battle-active' : ''}" onclick="viewActiveBattle('${log.id}')">
                        <div class="space-y-1">
                            <h4 class="text-lg font-bold text-secondary">${log.monsterEmoji} ${monster}</h4>
                            <p class="text-xs text-slate-400">Stage ${log.monsterStage} | Current HP: ${Math.max(0, currentHP)}</p>
                        </div>
                        <div class="w-1/2 ml-4 space-y-1">
                            <div class="progress-bar-container h-2 bg-danger">
                                <div class="progress-bar bg-danger/50" style="width: ${healthPct}%;"></div>
                            </div>
                            <div class="progress-bar-container h-2">
                                <div class="progress-bar bg-yellow-500" style="width: ${powerPct}%;"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-text-light">Power: ${power} / ${required}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewActiveBattle(logId) {
            if (logId === null) {
                // If logId is null, go back to the list view
                gameState.activeLogId = null;
            } else {
                 // If logId is provided, view that specific battle
                gameState.activeLogId = logId;
            }
            gameState.dashboardView = 'battle';
            updateUI(); // Re-render to show the correct battle/list view
        }

        function renderBattleState() {
            const log = getLogById(gameState.activeLogId);
            
            // CRITICAL FIX: If log is missing or defeated, reset to list view
            if (!log || log.status === 'Defeated') { 
                gameState.activeLogId = null;
                activeBattleView.classList.add('hidden');
                battleLogList.classList.remove('hidden');
                document.getElementById('encounter-history-list').classList.remove('hidden'); // Show history title
                renderBattleLogList();
                renderMonsterHistory(); 
                return; 
            }

            // --- Render Individual Battle View ---
            battleLogList.classList.add('hidden');
            document.getElementById('encounter-history-list').classList.add('hidden'); // Hide the history section title
            activeBattleView.classList.remove('hidden');
            activeBattleTitle.textContent = log.monsterName;

            const powerPct = (log.currentPower / log.monsterHealth) * 100;
            powerBar.style.width = `${powerPct}%`;
            powerText.textContent = `üõ°Ô∏è Quests Completed Power: ${log.currentPower} / ${log.monsterHealth}`;
            
            // Battle is always possible now
            const readyToLaunch = true; 
            
            launchBattleButton.onclick = launchTurnBasedBattle;
            
            if (log.currentPower >= 100) {
                 attackStatusMessage.innerHTML = `<span class="text-success font-semibold">Ready to Attack! Power ${log.currentPower} / ${log.monsterHealth}.</span>`;
                 launchBattleButton.classList.remove('bg-danger/50');
                 launchBattleButton.classList.add('bg-secondary');
            } else {
                 attackStatusMessage.innerHTML = `<span class="text-yellow-400">Complete quests to reach 100+ Power to launch battle.</span>`;
                 launchBattleButton.classList.add('bg-danger/50');
                 launchBattleButton.classList.remove('bg-secondary');
            }

            // Monster Display Card
            monsterDisplay.innerHTML = `
                <p class="text-7xl">${log.monsterEmoji}</p>
                <h4 class="text-2xl font-bold text-danger">${log.monsterName}</h4>
                <p class="text-sm text-slate-400 text-body">Stage ${log.monsterStage} | Health: ${log.monsterHealth} (Current: ${Math.max(0, log.monsterCurrentHP)})</p>
                <div class="mt-2 p-2 bg-slate-700 rounded-lg text-left">
                    <p class="text-xs font-semibold text-yellow-400">Active Skills:</p>
                    ${log.monsterSkills.map(s => `<p class="text-xs text-slate-300 ml-2">- ${s.name} (Effect: ${s.effect}, Damage: ${s.damage})</p>`).join('')}
                </div>
            `;

            renderTasks(log);
        }
        
        // NEW FEATURE: Task Guide Logic
        function showTaskGuide(taskName, description, instructions, proof) {
            const content = `
                <h4 class="text-lg font-bold text-secondary mb-2">${taskName}</h4>
                <p class="text-sm text-success font-semibold mb-4 text-body">Benefit: ${description}</p>
                <div class="p-3 bg-slate-800 rounded-lg space-y-2 text-left">
                    <p class="font-semibold text-primary">Instructions:</p>
                    <p class="text-sm text-text-light text-body">${instructions}</p>
                    <p class="font-semibold text-primary pt-2 border-t border-slate-700">Proof Required:</p>
                    <p class="text-sm text-text-light text-body">${proof}</p>
                </div>
                <p class="text-xs text-yellow-400 mt-3 text-body">Click 'Acknowledge' to close, then click the 'Submit Proof' button on the Quest card once done.</p>
            `;
            showGeneralModal('üìò Quest Guide', content);
        }


        /**
         * Utility function to escape single quotes and backslashes for use within a single-quoted JS string literal in HTML.
         * @param {string} str The string to escape.
         * @returns {string} The escaped string.
         */
        function escapeForJsString(str) {
            if (!str) return '';
            // Escape backslashes first to prevent them from escaping the quote characters in the next step.
            // Then escape single quotes, as they are used to wrap the JS function arguments in HTML.
            // Also escape double quotes if they were not intended to be there in the first place.
            return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }


        function renderTasks(log) {
            // Render the dynamically generated tasks for this specific log entry
            tasksList.innerHTML = log.tasks.map(quest => {
                const isCompleted = quest.completed;
                const buttonClass = isCompleted ? 'bg-success/50 cursor-default' : 'bg-primary hover:bg-primary/90';
                const buttonText = isCompleted ? '‚úÖ Proof Submitted' : `Submit Proof (+${quest.value} Power)`;
                
                // Find full task details for the guide
                const allQuests = ALL_QUESTS; // Use the global flattened array
                // FIX: Look up the quest details using the ID stored in the log entry.
                const fullQuest = allQuests.find(q => q.id === quest.id) || {
                    description: quest.description, // Fallback to log description if full entry missing
                    instructions: 'Instructions missing. Please refer to your recovery plan.', 
                    proof: 'Submit text proof describing your completion.'
                };
                
                // --- FIX: Use robust escaping for HTML attribute injection ---
                const cleanName = escapeForJsString(quest.name);
                const cleanDescription = escapeForJsString(fullQuest.description);
                const cleanInstructions = escapeForJsString(fullQuest.instructions);
                const cleanProof = escapeForJsString(fullQuest.proof);


                // Action for 'Submit Proof' button
                const action = isCompleted ? 'void(0)' : `openProofModal('${log.id}', '${quest.id}', '${cleanName}', ${quest.value})`;

                return `
                    <div class="app-card p-4 ${isCompleted ? 'border-success' : 'border-primary/50'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="space-y-1 mb-2 sm:mb-0 max-w-full sm:max-w-[60%]">
                                <h4 class="text-lg font-bold text-text-light">${quest.name}</h4>
                                <p class="text-xs text-slate-400 italic text-body break-words">${quest.description}</p>
                            </div>
                            <div class="flex flex-col space-y-2 w-full sm:w-auto mt-2 sm:mt-0">
                                <button 
                                    class="btn bg-slate-600 hover:bg-slate-700 text-white py-2 px-4 rounded-xl text-xs"
                                    onclick="showTaskGuide('${cleanName}', '${cleanDescription}', '${cleanInstructions}', '${cleanProof}')"
                                    >
                                    üìò Guide
                                </button>
                                <button 
                                    class="btn py-3 px-4 rounded-xl text-sm font-semibold w-full sm:w-auto ${buttonClass}"
                                    ${isCompleted ? 'disabled' : ''}
                                    onclick="${action}"
                                >
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSkillsView() {
            const skillsListContainer = document.getElementById('player-skills-list');
            
            PLAYER_SKILLS = ALL_PLAYER_SKILLS; // Re-initialize with latest names

            skillsListContainer.innerHTML = PLAYER_SKILLS.map(skill => {
                const canAfford = gameState.charXP >= skill.cost;
                const buttonClass = skill.unlocked ? 'bg-success/50 cursor-default' : (canAfford ? 'bg-secondary hover:bg-secondary/90' : 'bg-slate-600 cursor-not-allowed');
                const buttonText = skill.unlocked ? '‚úÖ UNLOCKED' : (canAfford ? `Unlock for ${skill.cost} XP` : `${skill.cost} XP Required`);
                const action = skill.unlocked || !canAfford ? 'void(0)' : `unlockSkillAttempt('${skill.id}')`;
                const costText = skill.unlocked ? 'Permanent Skill' : `${skill.cost} XP`;

                return `
                    <div class="app-card p-4 ${skill.unlocked ? 'border-success' : 'border-slate-500'}">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="space-y-1 mb-3 sm:mb-0 max-w-full sm:max-w-[70%]">
                                <h4 class="text-lg font-bold text-text-light">${skill.name} (${skill.type})</h4>
                                <p class="text-xs text-slate-400 italic text-body">${skill.desc}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-2 w-full sm:w-auto">
                                <p class="text-sm font-semibold ${skill.unlocked ? 'text-success' : 'text-secondary'}">${costText}</p>
                                <button 
                                    class="btn py-3 px-4 rounded-xl text-sm font-semibold w-full sm:w-auto ${buttonClass}"
                                    ${skill.unlocked || !canAfford ? 'disabled' : ''}
                                    onclick="${action}"
                                >
                                    ${buttonText}
                                </button>
                                ${skill.unlocked ? `<p class="text-xs text-slate-400 text-body">Power Cost: ${skill.powerCost}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function unlockSkillAttempt(skillId) {
            const skill = ALL_PLAYER_SKILLS.find(s => s.id === skillId);
            
            if (!skill) return;

            if (skill.unlocked) {
                showGeneralModal('Already Learned', `${skill.name} is already part of your arsenal.`);
                return;
            }
            
            if (gameState.charXP < skill.cost) {
                showGeneralModal('XP Insufficient', `You need **${skill.cost} XP** to unlock ${skill.name}. Keep winning battles!`);
                return;
            }
            
            // Process unlock
            gameState.charXP -= skill.cost;
            
            if (unlockSkill(skillId)) { // This calls the function that updates the global PLAYER_SKILLS and saves localStorage
                saveCharacter(gameState); // Save new XP amount
                showGeneralModal('‚ú® Skill Unlocked!', `You successfully learned **${skill.name}**! You can now use it in the Impulse Battle Arena.`);
                // Log skill unlock event
                logDataToSheet({ charName: gameState.charName, skillId: skillId, skillName: skill.name }, 'Skills');
                updateUI(); // Re-render everything
            }
        }

        function openProofModal(logId, taskId, taskName, powerValue) {
            // Find the quest in the log's tasks to ensure it's still available
            const log = getLogById(logId);
            if (!log) return;
            const quest = log.tasks.find(t => t.id === taskId);
            if (!quest || quest.completed) return;
            
            proofTaskIdInput.value = taskId;
            document.getElementById('proof-battle-id').value = logId;
            proofTaskName.textContent = taskName;
            proofPowerReward.textContent = `Reward: +${powerValue} Power`;
            
            // Reset form fields
            proofTypeSelect.value = "";
            handleProofTypeChange(""); // Reset dynamic fields
            
            proofModal.classList.remove('hidden');
        }

        /**
         * FIX: Restructured to handle asynchronous file reading and prevent premature modal closure.
         * The modal is only closed after a successful submission (either sync text or async file).
         */
        function submitTaskProof(event) {
            event.preventDefault();
            
            const logId = document.getElementById('proof-battle-id').value;
            const taskId = proofTaskIdInput.value;
            const proofType = proofTypeSelect.value;
            
            // Reference to the submit button for disabling
            const submitButton = event.target.querySelector('button[type="submit"]');

            if (!proofType) {
                 showGeneralModal('Validation Error', 'Please select a valid proof submission type first.');
                 return;
            }

            if (proofType === 'file') {
                const file = proofFileInput.files[0];
                if (!file) {
                    showGeneralModal('Validation Error', 'Please select a file proof to submit.');
                    return;
                }
                
                // Disable submit button temporarily
                if (submitButton) submitButton.disabled = true;

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Process submission ONLY after file reading is complete
                    processProofSubmission(logId, taskId, null, e.target.result, file.type.split('/')[0]);
                    
                    // Re-enable button and close modal after success
                    if (submitButton) submitButton.disabled = false;
                    closeProofModal();
                };
                reader.onerror = function() {
                     showGeneralModal('File Error', 'Could not read file. Please try a different file.');
                     // Re-enable button on error
                     if (submitButton) submitButton.disabled = false;
                };
                reader.readAsDataURL(file);

            } else if (proofType === 'text') {
                const textProof = proofTextarea.value.trim();
                if (!textProof) {
                    showGeneralModal('Validation Error', 'Please provide written proof to submit.');
                    return;
                }
                processProofSubmission(logId, taskId, textProof, null, 'text');
                closeProofModal(); // Safe to close immediately for sync task
            }
        }

        function processProofSubmission(logId, taskId, textProof, dataURL, type) {
             const logs = loadLogs();
             const logIndex = logs.findIndex(log => log.id === logId);

             if (logIndex !== -1) {
                 const log = logs[logIndex];
                 
                 // FIX: Find the quest in the log's tasks to get the correct value
                 const quest = log.tasks.find(t => t.id === taskId);
                 
                 // Update the specific task in the log
                 const taskIndex = log.tasks.findIndex(t => t.id === taskId);
                 if (taskIndex !== -1 && !log.tasks[taskIndex].completed) {
                     log.tasks[taskIndex].completed = true;
                     log.tasks[taskIndex].proofText = textProof || 'File proof submitted.';
                     // IMPORTANT: We temporarily include dataURL ONLY for immediate UI updates, but it is stripped in saveLog().
                     log.tasks[taskIndex].proofDataURL = dataURL; 
                     log.tasks[taskIndex].proofType = type;
                     log.currentPower += quest.value;

                     // Save and update UI
                     saveLog(log);
                     
                     // Log quest completion
                     logDataToSheet({ 
                         charName: gameState.charName, 
                         logId: logId, 
                         taskId: taskId, 
                         questName: quest.name, 
                         powerGained: quest.value, 
                         proofType: type 
                     }, 'Quests');

                     viewActiveBattle(logId);
                     showGeneralModal('üí™ Power Gained!', `You gained **+${quest.value} Power** for completing the quest: ${quest.name}. Keep going!`);
                 }
             }
        }


        // --- Impulse Log Form Logic (SIMPLIFIED) ---
        
        function setLogDateToToday() {
            const today = new Date().toISOString().split('T')[0];
            logDateInput.value = today;
            // Also reset form fields visually
            triggerForm.reset();
            logAfterFeelings.value = ''; // Ensure conditional fields are clear
            gaveInFields.classList.add('hidden');
            resistedFields.classList.remove('hidden');
        }

        function setupLogActionListeners() {
            // Attach event listener for Action Taken radio buttons
            const actionRadios = document.querySelectorAll('input[name="log-action"]');
            actionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const action = getRadioValue('log-action');
                    if (action === 'Gave In') {
                        gaveInFields.classList.remove('hidden');
                        logAfterFeelings.setAttribute('required', 'required');
                        resistedFields.classList.add('hidden');
                        logTriedInstead.removeAttribute('required');
                    } else {
                        gaveInFields.classList.add('hidden');
                        logAfterFeelings.removeAttribute('required');
                        logAfterFeelings.value = ''; // Clear input when hiding
                        resistedFields.classList.remove('hidden');
                        logTriedInstead.setAttribute('required', 'required');
                    }
                });
            });

            // Ensure the correct state is set on initial load/reset
            const initialAction = getRadioValue('log-action');
            if (initialAction === 'Gave In') {
                 gaveInFields.classList.remove('hidden');
                 resistedFields.classList.add('hidden');
            } else {
                 gaveInFields.classList.add('hidden');
                 resistedFields.classList.remove('hidden');
            }
        }

        triggerForm.onsubmit = function(event) {
            event.preventDefault();
            
            const triggerText = triggerSpecificInput.value.trim();
            if (!triggerText) {
                showMessage('Error', 'Please describe the Specific Impulse / Trigger Event.', 'danger');
                return;
            }
            
            // Close the log form after submission
            toggleLogForm();

            // 1. Get Trigger Type (Generic IMPULSE) and Monster Data
            const { type, emoji } = getTriggerType(triggerText);
            const monsterProgress = loadProgress();
            // Use the determined type for win count tracking
            const winCount = monsterProgress[type] ? monsterProgress[type].wins : 0; 
            const monsterData = getMonsterByCount(type, winCount);
            
            // 2. Calculate tasks based on monster type, health, and tasks multiplier (tasksMultiplier=1.0 for new spawn)
            // Use the determined type for quest generation
            const dynamicTasks = calculateTasksForMonster(monsterData.health, type, monsterData.tasks_multiplier);


            // 3. Build the new Log Entry
            const logId = crypto.randomUUID();
            const logEntry = {
                id: logId,
                logDate: logDateInput.value,
                // Removed logTime, logEmotion due to simplification
                triggerType: type, // Save determined type
                triggerSpecific: triggerText,
                logThoughts: document.getElementById('log-thoughts').value,
                actionTaken: getRadioValue('log-action'),
                afterFeelings: logAfterFeelings.value,
                triedInstead: logTriedInstead.value,

                // Monster / Battle Data
                monsterName: monsterData.name,
                monsterEmoji: monsterData.monsterEmoji, 
                monsterStage: monsterData.stage,
                monsterHealth: monsterData.health,
                monsterDefense: monsterData.defense || 0, 
                monsterSkills: monsterData.skills,
                currentPower: 0,
                status: 'Active', 
                tasks: dynamicTasks, 
                
                // NEW: Track current HP (defaults to max HP on spawn)
                monsterCurrentHP: monsterData.health, 
                
                // For log entry tracking
                charName: gameState.charName,
            };
            
            // 4. Save Log and Update Game State
            saveLog(logEntry);
            gameState.activeLogId = logId; 
            gameState.dashboardView = 'battle'; // Switch view to battle immediately

            // 5. Clean up form and UI
            triggerForm.reset();
            setLogDateToToday();
            updateUI(); 
            
            // Show encounter modal
            showGeneralModal('üö® Encounter Detected!', 
                `Your impulse has materialized as the **${monsterData.monsterEmoji} ${monsterData.name}**! (Type: ${type}, Stage ${monsterData.stage}).<br>Monster Health: **${monsterData.health}**. You have been assigned **${dynamicTasks.length} balanced Quests** to gain power for the Battle Arena!`);
        };


        // --- Battle Arena Logic ---

        function appendArenaLog(message, isPlayer = true) {
            const color = isPlayer ? 'text-primary' : 'text-danger';
            arenaLog.innerHTML += `<p class="${color} text-xs">${message}</p>`;
            arenaLog.scrollTop = arenaLog.scrollHeight; // Auto-scroll
        }
        
        function updateArenaHPDisplay() {
            const playerMaxHP = gameState.charHP;
            const monsterMaxHP = battleArenaState.currentMonsterLog.monsterHealth;

            const playerPct = Math.max(0, (battleArenaState.playerCurrentHP / playerMaxHP) * 100);
            const monsterPct = Math.max(0, (battleArenaState.monsterCurrentHP / monsterMaxHP) * 100);

            arenaPlayerHpBar.style.width = `${playerPct}%`;
            arenaPlayerHpText.textContent = `HP: ${Math.max(0, battleArenaState.playerCurrentHP)} / ${playerMaxHP}`;
            
            arenaMonsterHpBar.style.width = `${monsterPct}%`;
            arenaMonsterHpText.textContent = `HP: ${Math.max(0, battleArenaState.monsterCurrentHP)} / ${monsterMaxHP}`;
        }
        
        function updateArenaControls() {
            const isPlayerTurn = battleArenaState.isPlayerTurn;
            const log = battleArenaState.currentMonsterLog;
            const currentPower = log ? log.currentPower : 0;
            
            // Ensure buttons are only enabled on player turn
            document.getElementById('arena-attack-btn').disabled = !isPlayerTurn;
            document.getElementById('arena-defend-btn').disabled = !isPlayerTurn;
            document.getElementById('arena-run-btn').disabled = false; 

            // Render skills
            const skillButtons = [document.getElementById('arena-skill-1'), document.getElementById('arena-skill-2')];
            const unlockedSkills = ALL_PLAYER_SKILLS.filter(s => s.unlocked); // Use ALL_PLAYER_SKILLS

            skillButtons.forEach((btn, index) => {
                const skill = unlockedSkills[index];
                if (skill) {
                    const canUse = currentPower >= skill.powerCost;
                    btn.classList.remove('opacity-50');
                    // Skills are disabled if not player turn OR not enough power
                    btn.disabled = !isPlayerTurn || !canUse; 
                    btn.textContent = `${skill.name} (${skill.powerCost} P)`;
                    btn.setAttribute('onclick', `playerTurn('${skill.id}')`);
                    
                    btn.classList.remove('skill-card', 'bg-primary', 'bg-success', 'bg-secondary', 'bg-slate-600');
                    
                    if (canUse) {
                        btn.classList.add(skill.type === 'Attack' ? 'bg-secondary' : skill.type === 'Heal' ? 'bg-success' : 'bg-primary');
                    } else {
                        btn.classList.add('bg-slate-600', 'opacity-50');
                    }
                } else {
                     btn.classList.add('opacity-50');
                     btn.disabled = true;
                     btn.textContent = `(Skill Slot ${index + 1} - Locked)`;
                     btn.removeAttribute('onclick');
                     btn.classList.add('skill-card');
                     btn.classList.remove('bg-secondary', 'bg-primary', 'bg-success');
                     btn.classList.add('bg-slate-600');
                }
            });

            arenaMessage.textContent = battleArenaState.isLocked ? 'Sentinel is stunned! Turn skipped.' : (battleArenaState.isPlayerTurn ? 'Choose your next action!' : 'Monster is attacking...');
        }

        function launchTurnBasedBattle() {
            // CRITICAL FIX: Load the specific log entry using the activeLogId
            const activeLog = getLogById(gameState.activeLogId);
            if (!activeLog || activeLog.status !== 'Active') {
                 showGeneralModal('Error', 'No active monster selected, or monster has been defeated.', 'danger');
                 return;
            }
            
            // Initialize battle state
            battleArenaState.currentMonsterLog = activeLog;
            battleArenaState.monsterCurrentHP = activeLog.monsterCurrentHP; 
            battleArenaState.playerCurrentHP = gameState.charHP; 
            battleArenaState.isPlayerTurn = true;
            battleArenaState.isLocked = false;
            battleArenaState.playerDefending = false;
            // FIX: Reset debuffs at the start of a *new* battle instance
            battleArenaState.playerWillpowerModifier = 0;
            battleArenaState.playerFocusModifier = 0;
            
            // Render initial arena view
            arenaMonsterEmoji.textContent = activeLog.monsterEmoji;
            arenaMonsterName.textContent = activeLog.monsterName;
            arenaPlayerName.textContent = gameState.charName;
            arenaLog.innerHTML = '';
            
            updateArenaHPDisplay();

            appendArenaLog(`A wild ${activeLog.monsterName} (Stage ${activeLog.monsterStage}) appears!`, false);
            appendArenaLog(`Go, ${gameState.charName}!`);
            
            battleArenaModal.classList.remove('hidden');
            updateArenaControls();
        }

        /**
         * Calculates damage based on the player's effective stat.
         * @param {number} effectiveStat The Willpower or Focus value PLUS any temporary debuffs/buffs.
         * @param {number} multiplier Standard attack multiplier (usually 1).
         * @param {number} defense Opponent's base defense.
         * @param {boolean} isPlayer If true, applies Power Scaling.
         */
        function calculateDamage(effectiveStat, multiplier = 1, defense = 0, isPlayer = true) {
            
            // Damage is based on a random number near the stat, minus opponent's defense
            const rawDamage = Math.max(1, Math.floor(Math.random() * effectiveStat * 1.5) + (effectiveStat * 0.5));
            let finalDamage = Math.max(1, rawDamage * multiplier - defense);
            
            // Apply Power Scaling only if it's the player's attack
            if (isPlayer && battleArenaState.currentMonsterLog) {
                const log = battleArenaState.currentMonsterLog;
                const powerRatio = log.currentPower / log.monsterHealth;
                let powerBonus = 0;

                // Adjust damage based on how much extra power the player has
                if (powerRatio > 1.0) {
                    // Bonus damage is proportional to the excess power percentage
                    powerBonus = (powerRatio - 1.0) * 0.5; 
                    
                    // Apply this bonus to the existing damage
                    finalDamage = Math.round(finalDamage * (1 + powerBonus));

                    if (powerBonus >= 1.0) {
                         appendArenaLog('*** ABSOLUTE RUTHLESS ATTACK! (Damage x2.0+) ***', true);
                    } else if (powerBonus >= 0.5) {
                         appendArenaLog('** OVERCHARGED ATTACK! **', true);
                    } else if (powerBonus > 0) {
                         appendArenaLog('* Focused Power Bonus! *', true);
                    }
                } else {
                     finalDamage = Math.round(finalDamage * multiplier); // Normal damage if power < health
                }
            } else {
                 finalDamage = Math.round(finalDamage * multiplier); // Monster attack
            }
            
            return Math.round(finalDamage);
        }

        function playerTurn(action) {
            if (!battleArenaState.isPlayerTurn) return; // Check turn first

            // Determine player's effective stats for this turn
            let effectiveWillpower = Math.max(1, gameState.charWillpower + battleArenaState.playerWillpowerModifier);
            let effectiveFocus = Math.max(1, gameState.charFocus + battleArenaState.playerFocusModifier);
            
            const log = battleArenaState.currentMonsterLog;
            
            let damage = 0;
            let message = '';
            let skipMonsterTurn = false;
            let powerUsed = 0;
            
            // Reset temporary defense state (Defense is only for 1 turn)
            battleArenaState.playerDefending = false;

            // --- Strategy: Player Actions ---
            if (action === 'Attack') {
                // Standard attack relies on Willpower
                
                // If player is locked, they must use an unlock skill or skip turn.
                if (battleArenaState.isLocked) {
                    appendArenaLog(`Sentinel is LOCKED! Only a skill can break the lock. Turn skipped.`, true);
                    battleArenaState.isPlayerTurn = false;
                    setTimeout(monsterTurn, 1500);
                    updateArenaControls();
                    return;
                }

                damage = calculateDamage(effectiveWillpower, 1, log.monsterDefense || 0, true); 
                message = `${gameState.charName} launched a **Strike**!`;

            } else if (action === 'Defend') {
                // Defense relies on Focus (mental clarity to brace)
                battleArenaState.playerDefending = true;
                message = `${gameState.charName} activated **Guard**! Defense is boosted.`;
            
            } else {
                 const skill = ALL_PLAYER_SKILLS.find(s => s.id === action);
                 if (skill && skill.unlocked) {
                    if (log.currentPower < skill.powerCost) {
                        appendArenaLog(`You need ${skill.powerCost} Power to use ${skill.name}!`, true);
                        return; // Block skill use if power is insufficient
                    }
                    powerUsed = skill.powerCost;
                    
                    // Skill Logic
                    if (skill.id === 'thought_record') {
                         // Uses Focus for mental moves
                         damage = calculateDamage(effectiveFocus, 1.2, log.monsterDefense || 0, true); // +20% damage
                         battleArenaState.isLocked = false; // Cures LOCK
                         // FIX: Also cure other debuffs
                         battleArenaState.playerWillpowerModifier = 0;
                         battleArenaState.playerFocusModifier = 0;
                         message = `Sentinel used **${skill.name}**! All mental debuffs cleared, and it dealt ${damage} damage.`;
                    } else if (skill.id === 'mindfulness_shield') {
                         // Uses Focus
                         battleArenaState.playerDefending = true;
                         message = `Sentinel raised a **${skill.name}**! Defense is now razor sharp.`;
                    } else if (skill.id === 'delay_gratification') {
                         // Uses Willpower for self-control
                         battleArenaState.playerCurrentHP = Math.min(gameState.charHP, battleArenaState.playerCurrentHP + 10);
                         skipMonsterTurn = true; // Delays Monster turn
                         message = `Sentinel practiced **${skill.name}**, gaining 10 HP. Monster is confused and skips a turn.`;
                    } else if (skill.id === 'support_call') {
                         // Uses Willpower
                         damage = 10;
                         battleArenaState.playerCurrentHP = Math.min(gameState.charHP, battleArenaState.playerCurrentHP + 30);
                         message = `Sentinel called for **${skill.name}**! Gained 30 HP and a minor attack.`;
                    } else {
                         // Default case for any other skill that might be added later
                         damage = calculateDamage(effectiveWillpower, 1, log.monsterDefense || 0, true);
                         message = `${gameState.charName} used a skill, dealing ${damage} damage!`;
                    }
                 } else {
                     // Safety block, should not happen if controls are disabled correctly
                     return; 
                 }
            }
            
            // Deduct Power Cost
            if (powerUsed > 0) {
                 log.currentPower = Math.max(0, log.currentPower - powerUsed);
                 saveLog(log); // Persist the power deduction
                 appendArenaLog(`-${powerUsed} Power used. Remaining: ${log.currentPower}`, true);
            }


            // Apply Damage
            if (damage > 0) {
                 battleArenaState.monsterCurrentHP -= damage;
                 appendArenaLog(`It dealt **${damage}** damage to ${log.monsterName}!`, true);
            }
            
            updateArenaHPDisplay();
            checkBattleEnd();

            // FIX 2: If monster is still alive and we are NOT skipping its turn, transition to monsterTurn.
            if (battleArenaState.monsterCurrentHP > 0) {
                if (!skipMonsterTurn) {
                    battleArenaState.isPlayerTurn = false;
                    arenaMessage.textContent = 'Monster is preparing its attack...';
                    setTimeout(monsterTurn, 1500); // Monster attacks after 1.5s delay
                } else {
                    // Skip Monster Turn -> Player gets another turn
                    battleArenaState.isPlayerTurn = true;
                    updateArenaControls();
                }
            }
        }
        
        function monsterTurn() {
            // FIX 2: Added quick check to prevent execution if battle ended during playerTurn checkBattleEnd
            if (battleArenaState.monsterCurrentHP <= 0 || battleArenaState.playerCurrentHP <= 0) {
                // If battle ended, checkBattleEnd() already handled UI update and closure.
                return;
            }
            
            const log = battleArenaState.currentMonsterLog;
            const skills = log.monsterSkills;
            
            // Randomly select skill, ensuring there is at least one skill.
            const skillIndex = Math.floor(Math.random() * skills.length);
            const skill = skills[skillIndex];
            
            let damage = skill.damage;
            let message = `${log.monsterName} used **${skill.name}**!`;
            
            // Calculate effective defense
            // Defend action gives 3x base defense (Focus Defend is more potent than base defense)
            const playerEffectiveDefense = gameState.charDefense + (battleArenaState.playerDefending ? gameState.charDefense * 2 : 0);
            
            // Apply damage or effect
            if (skill.damage > 0) {
                // Monster attacks use base damage and don't benefit from player debuffs
                let finalDamage = Math.max(1, damage - playerEffectiveDefense);
                
                // Skill: Temporal Loop (Double Attack)
                if (skill.effect && skill.effect.includes('Double Attack')) {
                     finalDamage *= 2;
                }
                
                battleArenaState.playerCurrentHP -= finalDamage;
                message += ` It hit ${gameState.charName} for **${finalDamage}** HP!`;
            }

            // Handle specific effects (Debuffs) 
            if (skill.effect && skill.effect.includes('Lower Focus')) {
                battleArenaState.playerFocusModifier = Math.max(-4, battleArenaState.playerFocusModifier - 1); // Debuff by 1, minimum -4
                message += ` Focus lowered!`;
            } else if (skill.effect && skill.effect.includes('Lower Willpower')) {
                battleArenaState.playerWillpowerModifier = Math.max(-4, battleArenaState.playerWillpowerModifier - 1); // Debuff by 1, minimum -4
                message += ` Willpower lowered!`;
            } else if (skill.effect && skill.effect.includes('Lock')) {
                battleArenaState.isLocked = true;
                message += ` ${gameState.charName} is stunned (LOCKED)!`;
            }
            
            appendArenaLog(message, false);
            updateArenaHPDisplay();
            checkBattleEnd();

            // FIX 2: If player is still alive, hand control back to them.
            if (battleArenaState.playerCurrentHP > 0) {
                battleArenaState.isPlayerTurn = true;
                updateArenaControls();
            }
        }

        function checkBattleEnd() {
            if (battleArenaState.monsterCurrentHP <= 0) {
                endBattle(true);
            } else if (battleArenaState.playerCurrentHP <= 0) {
                endBattle(false);
            }
        }

        function endBattle(isVictory) {
            // Note: proofTextarea can be null if the function is called before initGame completes
            if(proofTextarea) {
                 proofTextarea.removeEventListener('input', handleProofTextareaInput);
            }
            
            // Safely close modal without relying on the specific element
            battleArenaModal.classList.add('hidden');

            // FIX: Reset debuffs at the end of the battle
            battleArenaState.playerWillpowerModifier = 0;
            battleArenaState.playerFocusModifier = 0;
            
            if (battleArenaState.currentMonsterLog) {
                 showAttackResult(battleArenaState.currentMonsterLog.id, isVictory);
            } else {
                 // Should not happen, but safe fallback
                 changeDashboardView('battle');
            }
        }

        function showAttackResult(logId, isVictory) {
            // Must reload logs to get the current state
            const logs = loadLogs();
            const logIndex = logs.findIndex(log => log.id === logId);
            if (logIndex === -1) return;
            
            const log = logs[logIndex];
            const monsterType = log.triggerType; // Use the actual type
            let xpReward = isVictory ? log.monsterHealth * 2 : 0;
            
            // Update global progression (win count)
            const monsterProgress = loadProgress();
            monsterProgress[monsterType] = monsterProgress[monsterType] || { wins: 0, defeats: 0 };

            if (isVictory) {
                log.status = 'Defeated';
                log.monsterCurrentHP = 0; // Final kill health
                monsterProgress[monsterType].wins++;
                showGeneralModal('üéâ VICTORY!', `You successfully defeated the **${log.monsterName}**! You earned **+${xpReward} XP** and fortified your resolve.`);
                // XP and Stats Gain
                gameState.charXP += xpReward;
                gameState.charDefense = Math.min(15, gameState.charDefense + 1); // Minor permanent defense gain
                
                // Log battle result
                logDataToSheet({ charName: gameState.charName, logId: logId, monsterName: log.monsterName, result: 'Victory', xpGained: xpReward, newDefense: gameState.charDefense }, 'Battles');
            } else {
                // FIX 3: Update current monster HP with the damage dealt from the arena state.
                // This ensures the damage persists when the user re-launches the battle.
                log.monsterCurrentHP = Math.max(0, battleArenaState.monsterCurrentHP);
                
                
                // Defeat resets power and keeps status as 'Active'
                log.status = 'Active'; 
                log.currentPower = 0; 
                
                monsterProgress[monsterType].defeats++; 

                // --- DIFFICULTY: Keep the multiplier at 1.0x on defeat ---
                const tasksMultiplierOnDefeat = 1.0; 
                
                // Generate new tasks based on the defeat multiplier
                log.tasks = calculateTasksForMonster(log.monsterHealth, monsterType, tasksMultiplierOnDefeat);

                showGeneralModal('üò≠ DEFEAT!', 
                    `The **${log.monsterEmoji} ${log.monsterName}** was too strong. **Your damage dealt persists!** But your Power has been reset to 0. **${log.tasks.length} New Quests** have been assigned to fortify your Willpower before a rematch!`);
                
                // Log battle result
                logDataToSheet({ charName: gameState.charName, logId: logId, monsterName: log.monsterName, result: 'Defeat', xpGained: 0, newDefense: gameState.charDefense }, 'Battles');
            }

            saveProgress(monsterProgress);
            saveLog(log);
            saveCharacter(gameState);
            
            // NEW FEATURE: Check for level up after XP gain
            checkLevelUp();

            // CRITICAL FIX: Reset activeLogId to null to view the list of all active encounters.
            gameState.activeLogId = null;
            changeDashboardView('battle'); 
        }

        
        // --- Profile View Logic (formerly Settings) ---
        
        function toggleSettingsEdit(enable) {
            // Include ALL fields, except fixed stats/purpose which are now excluded from the form
            const allSettingsFields = [
                settingsRealNameInput, settingsPhoneInput, settingsAgeInput, 
                settingsCityInput, settingsSourceInput, settingsGenderInput
            ];
            
            // Get references to buttons
            const editBtn = document.getElementById('edit-profile-btn');
            const saveBtn = document.getElementById('settings-save-btn');
            const cancelBtn = document.getElementById('settings-cancel-btn');
            
            // 1. Toggle field disabled state and opacity/cursor style
            allSettingsFields.forEach(field => {
                field.disabled = !enable;
                // Remove opacity/cursor styling when editing is ENABLED
                field.classList.toggle('opacity-70', !enable);
                field.classList.toggle('cursor-not-allowed', !enable);
            });
            
            // 2. Toggle buttons visibility and state
            editBtn.classList.toggle('hidden', enable);
            saveBtn.classList.toggle('hidden', !enable);
            cancelBtn.classList.toggle('hidden', !enable);

            if (!enable) {
                // If canceling (enable=false), reset the editable fields to the last saved state (gameState)
                // We re-call renderSettingsView with skipDisable=true to refresh values without creating recursion
                renderProfileView(true);
            }
        }


        function renderProfileView(skipDisable = false) {
            // Pre-fill the form with current character data
            // Private details
            settingsRealNameInput.value = gameState.charRealName; 
            settingsPhoneInput.value = gameState.charPhone;
            
            // Editable Details
            settingsCityInput.value = gameState.charCity; 
            settingsSourceInput.value = gameState.charSource; 
            settingsAgeInput.value = gameState.charAge || '';
            settingsGenderInput.value = gameState.charGender || ''; // NEW: Handle gender pre-fill
            
            if (!skipDisable) {
                // Ensure inputs are disabled initially when viewing the settings
                toggleSettingsEdit(false); 
            }
        }
        
        // Settings Form Submission Handler (Save)
        settingsForm.onsubmit = function(event) {
            event.preventDefault();
            
            // Check if form is actually enabled (edit mode)
            if (settingsRealNameInput.disabled) return;
            
            // Perform basic validation before saving
            if (!/^\d*$/.test(settingsPhoneInput.value)) {
                 showGeneralModal('Validation Error', 'Phone number must contain only digits.', 'danger');
                 return;
            }

            // Update only the remaining editable fields
            const newRealName = settingsRealNameInput.value.trim();
            gameState.charName = newRealName.split(' ')[0] || 'Sentinel'; // Update charName based on new real name
            gameState.charRealName = newRealName;
            gameState.charPhone = settingsPhoneInput.value.trim();
            gameState.charCity = settingsCityInput.value.trim(); 
            gameState.charSource = settingsSourceInput.value.trim(); 
            gameState.charAge = parseInt(settingsAgeInput.value) || 0;
            gameState.charGender = settingsGenderInput.value.trim(); // NEW: Save gender
            
            saveCharacter(gameState);
            
            // Disable inputs after successful save
            toggleSettingsEdit(false);
            
            updateUI();
            showGeneralModal('Profile Updated', 'Your Sentinel profile details have been successfully saved!');
        };
        
        function renderGuideView() {
            // The content is static HTML and only needs to be made visible
        }

        
        // --- Splash Screen & Initialization ---
        
        // CRITICAL FIX: Hide the body immediately, show the app after the splash screen.
        document.body.classList.add('hidden-init');
        splashScreen.classList.remove('hidden-init'); // Ensure splash is visible

        function initGame() {
            const characterData = loadCharacter();
            if (characterData) {
                // When loading existing minimal data, ensure hardcoded defaults are used for removed stats
                gameState = { ...INITIAL_STATE, ...characterData };
                // Ensure charName is set based on the real name if it exists (for old users)
                if (gameState.charRealName && gameState.charName === 'Sentinel') {
                    gameState.charName = gameState.charRealName.split(' ')[0] || 'Sentinel';
                }
                
                // Initialize form visibility states
                logFormContainer.classList.add('hidden');
                logFilterSection.classList.add('hidden');


                gameState.phase = 'input';
                gameState.dashboardView = 'log'; 
                
                // We only ensure the battle view is the default view if there ARE active monsters.
                const activeMonsters = loadLogs().filter(log => log.status === 'Active');
                if (activeMonsters.length > 0) {
                    gameState.dashboardView = 'battle';
                }

                showMessage(`Welcome back, Warrior ${gameState.charName}! Log your next impulse.`, 'info');
            } else {
                gameState.phase = 'creation';
                showMessage('Welcome! Please create your character to begin your journey.', 'info');
            }
            // Must load skills after setting initial state
            loadSkills();
            
            // Attach the input listener here, AFTER DOM elements are defined
            if(proofTextarea) {
                proofTextarea.addEventListener('input', handleProofTextareaInput);
            }

            updateUI();
        }

        function handleSplash() {
             // Delay to allow external assets (Tailwind) to load before calculating load time
             setTimeout(() => {
                splashScreen.classList.add('fade-out');
                // Hides splash and shows body after CSS transition is complete (1s)
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    document.body.classList.remove('hidden-init'); 
                    initGame();
                }, 1000); 
            }, 100); // Small initial delay
        }
        
        // Character Submission Handler (MINIMAL)
        characterForm.onsubmit = function(event) {
            event.preventDefault();
            
            if (!validateSingleStepForm()) {
                showMessage('Please complete all required fields to create your Sentinel.', 'danger');
                return;
            }

            const realName = document.getElementById('char-real-name').value;
            const formData = {
                realName: realName, 
                city: document.getElementById('char-city').value, 
                source: document.getElementById('char-source').value, 
                phone: document.getElementById('char-phone').value, 
                age: parseInt(document.getElementById('char-age').value) || 0,
                gender: document.getElementById('char-gender').value // NEW: Get gender
            };

            // Calculate final stats (includes setting charName from the first word of realName)
            const calculatedStats = calculateBaseStats(formData);
            
            // Default purpose since the input was removed
            calculatedStats.charPurpose = 'Master the Impulse.'; 

            gameState = { ...INITIAL_STATE, ...calculatedStats, phase: 'input', dashboardView: 'log' };
            saveCharacter(gameState); 
            
            // This is the critical final step: switching the view
            updateUI();
            
            // Log the new character creation to the sheet
            logDataToSheet(gameState, 'ProfileCreation');

            // NEW: Prompt the user to check the guide immediately after creation
           showGuideVideoModal('üé¨ Sentinel Guide: Your Mission Briefing', 
        `Welcome, **${gameState.charName}**! Your journey begins now. Your initial HP is ${gameState.charHP}.
         <br><br>
         Watch this short video to learn how to master the Impulse Battle Arena!<br><br>`,
        GUIDE_VIDEO_ID); // <-- Uses the constant defined in Step 1
        };

        // Proof Submission Handler
        proofForm.onsubmit = submitTaskProof;

        // UI Update Loop
        function updateUI() {
            loadSkills(); 
            
            charCreationSection.classList.add('hidden');
            triggerSection.classList.add('hidden');
            logViewContainer.classList.add('hidden');
            battleQuestContainer.classList.add('hidden');
            skillsViewContainer.classList.add('hidden'); 
            guideViewContainer.classList.add('hidden'); 
            profileViewContainer.classList.add('hidden'); 
            
            messageBox.classList.add('hidden');
            resetButton.classList.add('hidden');

            if (gameState.phase === 'creation') {
                charCreationSection.classList.remove('hidden');
            } else {
                
                // Always render stats first
                renderDashboard();
                
                const view = gameState.dashboardView;
                
                // Show the dashboard card ONLY if the current view is 'log'
                dashboardDisplay.classList.toggle('hidden', view !== 'log');


                // Update nav button classes
                const navButtons = [navLogBtn, navBattleBtn, navSkillsBtn, navGuideBtn, navProfileBtn]; 
                navButtons.forEach(btn => btn.classList.remove('bg-primary', 'bg-slate-600'));
                
                
                const activeNavBtn = document.getElementById(`nav-${view}`);
                if (activeNavBtn) {
                    activeNavBtn.classList.add('bg-primary');
                    navButtons.filter(btn => btn !== activeNavBtn).forEach(btn => btn.classList.add('bg-slate-600'));
                } else {
                    // Default to log view if state is corrupt
                    navLogBtn.classList.add('bg-primary');
                    navBattleBtn.classList.add('bg-slate-600');
                    navSkillsBtn.classList.add('bg-slate-600');
                    navGuideBtn.classList.add('bg-slate-600');
                    navProfileBtn.classList.add('bg-slate-600');
                }
                
                // Show the main trigger section content block
                triggerSection.classList.remove('hidden');


                if (view === 'log') {
                    logViewContainer.classList.remove('hidden');
                    filterLogHistory(); 
                } else if (view === 'battle') {
                    battleQuestContainer.classList.remove('hidden');
                     
                    if (gameState.activeLogId) {
                        activeBattleView.classList.remove('hidden');
                        battleLogList.classList.add('hidden');
                        document.getElementById('encounter-history-list').classList.remove('hidden');
                        renderBattleState(); 
                    } else {
                        activeBattleView.classList.add('hidden');
                        battleLogList.classList.remove('hidden');
                        document.getElementById('encounter-history-list').classList.remove('hidden');
                        renderBattleLogList(); 
                        renderMonsterHistory();
                    }
                } else if (view === 'skills') {
                    skillsViewContainer.classList.remove('hidden');
                    renderSkillsView();
                } else if (view === 'profile') { // Updated view name check
                    profileViewContainer.classList.remove('hidden');
                    renderProfileView();
                } else if (view === 'guide') { 
                    guideViewContainer.classList.remove('hidden');
                    renderGuideView();
                }
                
                if (gameState.phase === 'input') {
                    setLogDateToToday();
                    setupLogActionListeners();
                }
            }
        }
        
        // --- Proof Image/Text Preview Handlers ---

        function previewProofImage(event) {
            const file = event.target.files[0];
            proofPreview.innerHTML = 'File selected...'; 
            
            if (file) {
                const fileType = file.type;
                if (fileType.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        proofPreview.innerHTML = `<img src="${e.target.result}" alt="Proof Image Preview">`;
                    };
                    reader.readAsDataURL(file);
                } else if (fileType.startsWith('video/')) {
                     proofPreview.innerHTML = `<video src="${URL.createObjectURL(file)}" controls muted></video>`;
                } else if (fileType.startsWith('audio/')) {
                    proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm"><span class="text-primary">üé§ Voice/Audio Recording</span><audio src="${URL.createObjectURL(file)}" controls class="w-full mt-2"></audio></div>`;
                } else {
                    proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm text-center"><span class="text-primary">üìÑ Document/Text File Selected</span><br>Filename: ${file.name}</div>`;
                }
                proofTextarea.value = '';
            } else {
                proofPreview.innerHTML = 'Upload your file...';
            }
        }
        
        function handleProofTextareaInput() {
             if (proofTextarea.value.trim() !== '') {
                proofFileInput.value = '';
                proofPreview.innerHTML = `<div class="p-4 bg-slate-600 rounded-lg text-sm text-center"><span class="text-primary">üìù Text Proof Entered</span></div>`;
            } else {
                 proofPreview.innerHTML = 'Upload your file...';
            }
        }


        // Initialize UI on load
        window.onload = handleSplash;

    </script>
</body>
</html>
